<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现 | ZephyrHe</title><meta name=author content="HeZephyr">
<meta name=author-link content="https://github.com/HeZephyr"><meta name=description content="1 1 实验要求 本实验旨在利用lab 3中的Raft库，构建一个具备容错能力的键值存储服务。服务将作为一个复制状态机，由多个服务器组成，各服务器通过Raft协议同步数据库状态。即使在部分故障或网络隔离的情况下，只要大多数服务器正常，服务仍需继续响应客户端请求。在lab 4完成后，你将实现图中Raft交互的所"><meta name=keywords content='分布式系统'><meta itemprop=name content="【MIT 6.5840(6.824)】 Lab 4:Fault-tolerant KVService 设计实现"><meta itemprop=description content="1 1 实验要求 本实验旨在利用lab 3中的Raft库，构建一个具备容错能力的键值存储服务。服务将作为一个复制状态机，由多个服务器组成，各服务器通过Raft协议同步数据库状态。即使在部分故障或网络隔离的情况下，只要大多数服务器正常，服务仍需继续响应客户端请求。在lab 4完成后，你将实现图中Raft交互的所"><meta itemprop=datePublished content="2024-08-30T00:00:00+00:00"><meta itemprop=dateModified content="2024-08-30T22:55:44+08:00"><meta itemprop=wordCount content="3904"><meta itemprop=image content="https://hezephyr.github.io/images/apple-devices-preview.webp"><meta itemprop=keywords content="分布式系统"><meta property="og:url" content="https://hezephyr.github.io/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/"><meta property="og:site_name" content="ZephyrHe"><meta property="og:title" content="【MIT 6.5840(6.824)】 Lab 4:Fault-tolerant KVService 设计实现"><meta property="og:description" content="1 1 实验要求 本实验旨在利用lab 3中的Raft库，构建一个具备容错能力的键值存储服务。服务将作为一个复制状态机，由多个服务器组成，各服务器通过Raft协议同步数据库状态。即使在部分故障或网络隔离的情况下，只要大多数服务器正常，服务仍需继续响应客户端请求。在lab 4完成后，你将实现图中Raft交互的所"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-30T00:00:00+00:00"><meta property="article:modified_time" content="2024-08-30T22:55:44+08:00"><meta property="article:tag" content="分布式系统"><meta property="og:image" content="https://hezephyr.github.io/images/apple-devices-preview.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hezephyr.github.io/images/apple-devices-preview.webp"><meta name=twitter:title content="【MIT 6.5840(6.824)】 Lab 4:Fault-tolerant KVService 设计实现"><meta name=twitter:description content="1 1 实验要求 本实验旨在利用lab 3中的Raft库，构建一个具备容错能力的键值存储服务。服务将作为一个复制状态机，由多个服务器组成，各服务器通过Raft协议同步数据库状态。即使在部分故障或网络隔离的情况下，只要大多数服务器正常，服务仍需继续响应客户端请求。在lab 4完成后，你将实现图中Raft交互的所"><meta name=application-name content="Zephyr's Blog"><meta name=apple-mobile-web-app-title content="Zephyr's Blog"><meta name=theme-color data-light=#ffffff data-dark=#252627 content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://hezephyr.github.io/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/><link rel=prev href=https://hezephyr.github.io/posts/09.%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0grove/><link rel=next href=https://hezephyr.github.io/about/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://unpkg.com/@fortawesome/fontawesome-free@6.4.2/css/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@6.4.2/css/all.min.css></noscript><link rel=preload href=https://unpkg.com/animate.css@4.1.1/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"【MIT 6.5840(6.824)】 Lab 4:Fault-tolerant KVService 设计实现","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/hezephyr.github.io\/posts\/09.mit-6.58406.824-lab4-fault-tolerant-kvservice\/"},"image":[{"@type":"ImageObject","url":"https:\/\/hezephyr.github.io\/images\/apple-devices-preview.webp","width":2880,"height":1508}],"genre":"posts","keywords":"分布式系统","wordcount":3904,"url":"https:\/\/hezephyr.github.io\/posts\/09.mit-6.58406.824-lab4-fault-tolerant-kvservice\/","datePublished":"2024-08-30T00:00:00+00:00","dateModified":"2024-08-30T22:55:44+08:00","license":"本站内容采用 CC BY-NC-SA 4.0 国际许可协议。","publisher":{"@type":"Organization","name":"Lruihao","logo":"https:\/\/hezephyr.github.io\/images\/avatar.jpg"},"author":{"@type":"Person","name":"HeZephyr"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title=ZephyrHe><img loading=lazy src=/images/logo.png alt=ZephyrHe data-title=ZephyrHe width=26 height=26 class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>HeZephyr</span></a><span class=header-subtitle>贺志飞的博客</span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users-viewfinder fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=ZephyrHe><img loading=lazy src=/images/logo.png alt=ZephyrHe data-title=ZephyrHe width=26 height=26 class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>HeZephyr</span></a><span class=header-subtitle>贺志飞的博客</span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users-viewfinder fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item text-center"><a class=menu-link href=https://github.com/HeZephyr/HeZephyr.github.io title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item><a href=/posts/ title=Posts>文章</a></li><li class="breadcrumb-item active" aria-current=page>【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现</li></ol></nav><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集><div class="details collection-details open"><div class="details-summary collection-summary"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i>
<span class=collection-name data-collections=合集>MIT 6.5840</span>
<span class=collection-count>9</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content collection-content"><nav><ul class=collection-list><li class=collection-item><a href=/posts/01.%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%BB%8B%E7%BB%8D/ title="【MIT 6.5840(6.824)学习笔记】 分布式系统介绍">【MIT 6.5840(6.824)学习笔记】 分布式系统介绍</a></li><li class=collection-item><a href=/posts/05.mit-6.58406.824-lab1mapreduce-%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/ title="【MIT 6.5840(6.824)】Lab1:MapReduce 设计实现">【MIT 6.5840(6.824)】Lab1:MapReduce 设计实现</a></li><li class=collection-item><a href=/posts/06.mit-6.58406.824-lab2-kv-server/ title="【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现">【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现</a></li><li class=collection-item><a href=/posts/02.%E4%BD%BF%E7%94%A8go%E8%BF%9B%E8%A1%8C%E7%BA%BF%E7%A8%8B%E5%92%8Crpc%E7%BC%96%E7%A8%8B/ title="【MIT 6.5840(6.824)学习笔记】使用Go进行线程和RPC编程">【MIT 6.5840(6.824)学习笔记】使用Go进行线程和RPC编程</a></li><li class=collection-item><a href=/posts/03.%E6%B5%8B%E8%AF%95%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%BA%BF%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7/ title="【MIT 6.5840(6.824)学习笔记】 测试分布式系统的线性一致性">【MIT 6.5840(6.824)学习笔记】 测试分布式系统的线性一致性</a></li><li class=collection-item><a href=/posts/04.gfs/ title="【MIT 6.5840(6.824)学习笔记】GFS">【MIT 6.5840(6.824)学习笔记】GFS</a></li><li class=collection-item><a href=/posts/07.raft/ title="【MIT 6.5840(6.824)学习笔记】Raft">【MIT 6.5840(6.824)学习笔记】Raft</a></li><li class=collection-item><a href=/posts/08.mit-6.58406.824-lab3-raft/ title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现">【MIT 6.5840(6.824) 】Lab3:Raft 设计实现</a></li><li class=collection-item><span class=active title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现">【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现</span></li></ul><div class=collection-nav-simple><a href=/posts/08.mit-6.58406.824-lab3-raft/ class=collection-nav-item rel=prev title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i></a><span class=text-secondary>9/9</span><i class="fa-solid fa-angle-right fa-fw collection-nav-item text-secondary" aria-hidden=true></i></div></nav></div></div><div class="details collection-details"><div class="details-summary collection-summary"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i>
<span class=collection-name data-collections=合集>动手实践</span>
<span class=collection-count>4</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content collection-content"><nav><ul class=collection-list><li class=collection-item><a href=/posts/05.mit-6.58406.824-lab1mapreduce-%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/ title="【MIT 6.5840(6.824)】Lab1:MapReduce 设计实现">【MIT 6.5840(6.824)】Lab1:MapReduce 设计实现</a></li><li class=collection-item><a href=/posts/06.mit-6.58406.824-lab2-kv-server/ title="【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现">【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现</a></li><li class=collection-item><a href=/posts/08.mit-6.58406.824-lab3-raft/ title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现">【MIT 6.5840(6.824) 】Lab3:Raft 设计实现</a></li><li class=collection-item><span class=active title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现">【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现</span></li></ul><div class=collection-nav-simple><a href=/posts/08.mit-6.58406.824-lab3-raft/ class=collection-nav-item rel=prev title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i></a><span class=text-secondary>4/4</span><i class="fa-solid fa-angle-right fa-fw collection-nav-item text-secondary" aria-hidden=true></i></div></nav></div></div></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/HeZephyr title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img loading=lazy src="https://cn.gravatar.com/avatar/65f6ab71abcb9d540eb32a2704884927?s=32&amp;d=mp" alt=HeZephyr data-title=HeZephyr width=20 height=20 class=avatar style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'>&nbsp;HeZephyr</a></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/ class=post-category title="分类 - 系统架构"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 系统架构</a> 和 <a href=/collections/mit-6.5840/ class=post-collection title="合集 - MIT 6.5840"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> MIT 6.5840</a>&ensp;<a href=/collections/%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5/ class=post-collection title="合集 - 动手实践"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> 动手实践</a></span></div><div class=post-meta-line><span title="发布于 2024-08-30 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-08-30>2024-08-30</time></span>&nbsp;<span title="更新于 2024-08-30 22:55:44"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2024-08-30>2024-08-30</time></span>&nbsp;<span title="3904 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 4000 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 8 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现">
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#1-实验要求>1 实验要求</a></li><li><a href=#2-实验设计>2 实验设计</a><ol><li><a href=#21-思路>2.1 思路</a></li><li><a href=#22-lab4a无快照>2.2 lab4A：无快照</a><ol><li><a href=#221-客户端>2.2.1 客户端</a></li><li><a href=#222-服务端>2.2.2 服务端</a></li><li><a href=#223-applier>2.2.3 applier</a></li></ol></li><li><a href=#22-lab4b有快照>2.2 lab4B：有快照</a></li></ol></li><li><a href=#3-压测结果>3 压测结果</a></li></ol></nav></div></div><div class=content id=content data-end-flag="「本文完，更多内容汇总在我的 GitHub与CSDN，持续更新，求关注、求 star、求订阅！」"><h2 id=1-实验要求 class=heading-element><span>1 1 实验要求</span>
<a href=#1-%e5%ae%9e%e9%aa%8c%e8%a6%81%e6%b1%82 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p><font color=red>本实验旨在利用lab 3中的Raft库，构建一个具备容错能力的键值存储服务</font>。服务将作为一个复制状态机，由多个服务器组成，各服务器通过Raft协议同步数据库状态。即使在部分故障或网络隔离的情况下，只要大多数服务器正常，服务仍需继续响应客户端请求。在lab 4完成后，你将实现图中Raft交互的所有部分（Clerk、Service和Raft）。</p><p><a class=lightgallery href="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png?size=large" data-thumbnail="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png?size=small" data-sub-html="<h2>x</h2>"><img loading=lazy src=https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png alt=x srcset="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png?size=small, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png?size=medium 1.5x, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png?size=large 2x" data-title=x style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><p>客户端通过Clerk与键值服务交互，发送RPC请求，支持Put、Append和Get三种操作。服务需确保这些操作线性化，如果逐个调用，这些方法应表现得好像系统只有一个状态副本，每个调用都应观察到前序调用序列对状态的修改。对于并发调用，返回值和最终状态必须与操作按某种顺序逐个执行时相同。如果调用在时间上重叠，则认为是并发调用。</p><p>为单一服务器提供线性化相对容易，但如果服务是复制的，则较为困难，因为所有服务器必须为并发请求选择相同的执行顺序，避免使用过时的状态回复客户端，并在故障恢复时以保留所有确认的客户端更新为前提。Raft 作者的<a href=https://web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf target=_blank rel="external nofollow noopener noreferrer">博士论文<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>的第 6.3 小节介绍了如何实现线性化语义，在知乎上也有关于这方面的<a href=https://www.zhihu.com/question/278551592 target=_blank rel="external nofollow noopener noreferrer">讨论<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>，可以参考 dragonboat 作者的回答。</p><p>实验分为两个阶段：A阶段实现基于Raft的键值服务，不使用快照；B阶段则集成快照功能，优化日志管理。</p><p>我的实验代码仓库：https://github.com/HeZephyr/MIT6.5840/tree/main/src/kvraft，已通过压力测试，代码严格遵守上述按要求实现。</p><p><font color=red>注意：下述所贴代码为了简洁以及分块，进行了一定程度的删减，如果需要复现，可以前往仓库。</font></p><h2 id=2-实验设计 class=heading-element><span>2 2 实验设计</span>
<a href=#2-%e5%ae%9e%e9%aa%8c%e8%ae%be%e8%ae%a1 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 id=21-思路 class=heading-element><span>2.1 2.1 思路</span>
<a href=#21-%e6%80%9d%e8%b7%af class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>lab4需要我们基于lab3实现的Raft，实现一个可用的KV服务，这意味着我们需要保证线性一致性（要求从外部观察者的角度来看，所有操作都按照某个全局顺序执行，并且结果与这些操作按该顺序串行执行的结果相同）。尽管 Raft 共识算法本身支持线性化语义，但要真正保证线性化语义在整个系统中生效，仍然需要上层服务的配合。</p><p>例如，在下面这张图中：x初始值为0，client1发送put请求(x,1)，client2发送put请求(x,2)，并在put请求前后发送get请求，此时如果put请求因为超时不断重发，如果在client2的put请求之后才被应用，则导致最后client2读到的是1，RaftKV的结果也是1，这就违背了线性一致性。</p><p><a class=lightgallery href="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240822144442922.png?size=large" data-thumbnail="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240822144442922.png?size=small" data-sub-html="<h2>image-20240822144442922</h2>"><img loading=lazy src=https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240822144442922.png alt=image-20240822144442922 srcset="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240822144442922.png?size=small, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240822144442922.png?size=medium 1.5x, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240822144442922.png?size=large 2x" data-title=image-20240822144442922 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><p>这是因为当客户端向服务端提交command时，服务端在Raft层中同步、提交并应用后，客户端因为没有收到请求回复，会重试此操作，这种重试机制会导致相同的命令被执行多次。<font color=red>注意，这里讨论的都是写请求，因为读请求不会改变系统状态，可以重复执行多次。</font></p><p>为了解决重复执行命令导致线性一致性破坏的问题，Raft 作者提出了一种解决方案：客户端为每个命令分配一个唯一的序列号。状态机会记录每个客户端的最新序列号及其对应的执行结果。如果一个命令的序列号已经被处理过，则系统会直接返回先前的结果，而不会重新执行该命令。这样可以确保每个命令只被应用到状态机一次，避免了重复执行可能带来的线性一致性问题。</p><p>在这个lab中，我们可以按照如下机制具体实现：</p><ol><li><strong>客户端命令唯一化</strong>：每个客户端发送给服务端的每个<code>command</code>请求都携带一个由<code>ClientId</code>和<code>CommandId</code>组成的二元组。<code>ClientId</code>是客户端的唯一标识符，<code>CommandId</code>是一个递增的整数，用于唯一标识客户端发出的每一个命令。</li><li><strong>服务器端状态记录</strong>：在服务器端，维护一个映射表，这个映射表以<code>ClientId</code>作为主键，其值是一个结构体包含：<ul><li>最近执行的来自该客户端的<code>CommandId</code>。</li><li>对应的命令执行结果。</li></ul></li><li><strong>重复命令检测与处理</strong>：<ul><li>当一个新命令到达时，首先检查映射表中是否存在对应的<code>ClientId</code>条目。</li><li>如果存在，则比较新命令的<code>CommandId</code>与映射表中记录的<code>CommandId</code>。<ul><li>如果新命令的<code>CommandId</code>小于或等于记录的<code>CommandId</code>，则说明这是一个重复命令，服务器可以直接返回之前存储的结果。</li><li>如果新命令的<code>CommandId</code>大于记录的<code>CommandId</code>，则说明这是新的命令，服务器应该正常处理这个命令，并更新映射表中对应<code>ClientId</code>的<code>CommandId</code>及结果。</li></ul></li><li>如果不存在对应的<code>ClientId</code>条目，则将此命令视为首次出现的命令进行处理，并添加一个新的条目到映射表中。</li></ul></li></ol><h3 id=22-lab4a无快照 class=heading-element><span>2.2 2.2 lab4A：无快照</span>
<a href=#22-lab4a%e6%97%a0%e5%bf%ab%e7%85%a7 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>整体的时序图如下所示：</p><p><a class=lightgallery href="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240829224033039.png?size=large" data-thumbnail="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240829224033039.png?size=small" data-sub-html="<h2>image-20240829224033039</h2>"><img loading=lazy src=https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240829224033039.png alt=image-20240829224033039 srcset="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240829224033039.png?size=small, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240829224033039.png?size=medium 1.5x, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240829224033039.png?size=large 2x" data-title=image-20240829224033039 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><h4 id=221-客户端 class=heading-element><span>2.2.1 2.2.1 客户端</span>
<a href=#221-%e5%ae%a2%e6%88%b7%e7%ab%af class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p>对于客户端，需要有<code>(clientId, commandId)</code>来标识唯一命令，对于<code>clientId</code>，通过lab提供的随机数生成器<code>nrand</code>生成即可，对于<code>commandId</code>，可以采用递增的方式进行管理。这意味着每当客户端发送一个新的命令时，<code>commandId</code>都会递增一次，从而确保每个命令都有一个唯一的标识符，这样也需要保证如果这条命令没处理完（请求的server不是leader或者请求超时）需重复执行的时候，不能改变commandId。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CommandArgs</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Key</span>       <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Value</span>     <span class=kt>string</span>
</span></span><span class=line><span class=cl>	<span class=nx>Op</span>        <span class=nx>OpType</span>
</span></span><span class=line><span class=cl>	<span class=nx>ClientId</span>  <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=nx>CommandId</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>CommandReply</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>Err</span>   <span class=nx>Err</span>
</span></span><span class=line><span class=cl>	<span class=nx>Value</span> <span class=kt>string</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Clerk</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>servers</span> <span class=p>[]</span><span class=o>*</span><span class=nx>labrpc</span><span class=p>.</span><span class=nx>ClientEnd</span>
</span></span><span class=line><span class=cl>	<span class=nx>leaderId</span>  <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>clientId</span>  <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=nx>commandId</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>ck</span> <span class=o>*</span><span class=nx>Clerk</span><span class=p>)</span> <span class=nf>Get</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>ck</span><span class=p>.</span><span class=nf>ExecuteCommand</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>CommandArgs</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>Op</span><span class=p>:</span> <span class=nx>OpGet</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>ck</span> <span class=o>*</span><span class=nx>Clerk</span><span class=p>)</span> <span class=nf>Put</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>value</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ck</span><span class=p>.</span><span class=nf>ExecuteCommand</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>CommandArgs</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>Op</span><span class=p>:</span> <span class=nx>OpPut</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>ck</span> <span class=o>*</span><span class=nx>Clerk</span><span class=p>)</span> <span class=nf>Append</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>,</span> <span class=nx>value</span> <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>ck</span><span class=p>.</span><span class=nf>ExecuteCommand</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>CommandArgs</span><span class=p>{</span><span class=nx>Key</span><span class=p>:</span> <span class=nx>key</span><span class=p>,</span> <span class=nx>Value</span><span class=p>:</span> <span class=nx>value</span><span class=p>,</span> <span class=nx>Op</span><span class=p>:</span> <span class=nx>OpAppend</span><span class=p>})</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>ck</span> <span class=o>*</span><span class=nx>Clerk</span><span class=p>)</span> <span class=nf>ExecuteCommand</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>CommandArgs</span><span class=p>)</span> <span class=kt>string</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>args</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>CommandId</span> <span class=p>=</span> <span class=nx>ck</span><span class=p>.</span><span class=nx>clientId</span><span class=p>,</span> <span class=nx>ck</span><span class=p>.</span><span class=nx>commandId</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>reply</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>CommandReply</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=p>!</span><span class=nx>ck</span><span class=p>.</span><span class=nx>servers</span><span class=p>[</span><span class=nx>ck</span><span class=p>.</span><span class=nx>leaderId</span><span class=p>].</span><span class=nf>Call</span><span class=p>(</span><span class=s>&#34;KVServer.ExecuteCommand&#34;</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=nx>reply</span><span class=p>)</span> <span class=o>||</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Err</span> <span class=o>==</span> <span class=nx>ErrWrongLeader</span> <span class=o>||</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Err</span> <span class=o>==</span> <span class=nx>ErrTimeout</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>ck</span><span class=p>.</span><span class=nx>leaderId</span> <span class=p>=</span> <span class=p>(</span><span class=nx>ck</span><span class=p>.</span><span class=nx>leaderId</span> <span class=o>+</span> <span class=mi>1</span><span class=p>)</span> <span class=o>%</span> <span class=nb>len</span><span class=p>(</span><span class=nx>ck</span><span class=p>.</span><span class=nx>servers</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>ck</span><span class=p>.</span><span class=nx>commandId</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Value</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 id=222-服务端 class=heading-element><span>2.2.2 2.2.2 服务端</span>
<a href=#222-%e6%9c%8d%e5%8a%a1%e7%ab%af class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><code>KVServer</code>结构体被设计成一个基于Raft一致性协议实现的键值存储服务。为了确保客户端请求的幂等性，并且能够正确地处理来自客户端的重复请求，<code>lastOperations</code>映射表用于跟踪每个客户端（由<code>clientId</code>标识）的最后已应用的<code>commandId</code>以及相应的<code>reply</code>。这使得服务器能够在接收到重复请求时返回之前的结果而无需再次执行相同的命令。</p><p>状态机<code>stateMachine</code>在此处被实现为内存中的键值对存储<code>MemoryKV</code>，这意味着所有的键值对数据都保存在内存中，这对于快速读写操作是非常有效的，但可能不是持久化存储的最佳选择，因为如果服务器重启或崩溃，所有数据都会丢失。</p><p><code>lastApplied</code>字段被用来记录最后应用到状态机的日志条目的索引，以此来避免处理那些已经被应用过的过期日志条目。</p><p><code>notifyChs</code>是一个映射，它的键是日志条目的索引，值是一个<code>channel</code>。用于通知Raft的处理结果（机即复制到大多数副本并且应用到状态机之后）。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>KVServer</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>mu</span>      <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>
</span></span><span class=line><span class=cl>	<span class=nx>me</span>      <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span>      <span class=o>*</span><span class=nx>raft</span><span class=p>.</span><span class=nx>Raft</span>
</span></span><span class=line><span class=cl>	<span class=nx>applyCh</span> <span class=kd>chan</span> <span class=nx>raft</span><span class=p>.</span><span class=nx>ApplyMsg</span>
</span></span><span class=line><span class=cl>	<span class=nx>dead</span>    <span class=kt>int32</span> <span class=c1>// set by Kill()
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>maxraftstate</span> <span class=kt>int</span> <span class=c1>// snapshot if log grows this big
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>lastApplied</span>  <span class=kt>int</span> <span class=c1>//record the last applied index to avoid duplicate apply
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>stateMachine</span>   <span class=nx>KVStateMachine</span>
</span></span><span class=line><span class=cl>	<span class=nx>lastOperations</span> <span class=kd>map</span><span class=p>[</span><span class=kt>int64</span><span class=p>]</span><span class=nx>OperationContext</span>
</span></span><span class=line><span class=cl>	<span class=nx>notifyChs</span>      <span class=kd>map</span><span class=p>[</span><span class=kt>int</span><span class=p>]</span><span class=kd>chan</span> <span class=o>*</span><span class=nx>CommandReply</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>KVStateMachine</span> <span class=kd>interface</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nf>Get</span><span class=p>(</span><span class=nx>key</span> <span class=kt>string</span><span class=p>)</span> <span class=p>(</span><span class=kt>string</span><span class=p>,</span> <span class=nx>Err</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nf>Put</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=kt>string</span><span class=p>)</span> <span class=nx>Err</span>
</span></span><span class=line><span class=cl>	<span class=nf>Append</span><span class=p>(</span><span class=nx>key</span><span class=p>,</span> <span class=nx>value</span> <span class=kt>string</span><span class=p>)</span> <span class=nx>Err</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>type</span> <span class=nx>OperationContext</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>MaxAppliedCommandId</span> <span class=kt>int64</span>
</span></span><span class=line><span class=cl>	<span class=nx>LastReply</span>           <span class=o>*</span><span class=nx>CommandReply</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>ExecuteCommand</code>RPC实现如下，这段首先检查是否不是Get请求且为重复的命令，如果是则返回上次的结果，否则通过Raft的<code>Start</code>方法复制并应用日志，如果<code>Start</code>方法返回结果告知当前server不是Leader，则返回<code>ErrWrongLeader</code>，否则，去注册一个channel去阻塞等待执行结果（因为Start返回只是代表日志被复制到大多数节点中，有没有应用还不知道），这个执行结果由<code>applier</code>协程push。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>kv</span> <span class=o>*</span><span class=nx>KVServer</span><span class=p>)</span> <span class=nf>ExecuteCommand</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>CommandArgs</span><span class=p>,</span> <span class=nx>reply</span> <span class=o>*</span><span class=nx>CommandReply</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Op</span> <span class=o>!=</span> <span class=nx>OpGet</span> <span class=o>&amp;&amp;</span> <span class=nx>kv</span><span class=p>.</span><span class=nf>isDuplicatedCommand</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>CommandId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>lastReply</span> <span class=o>:=</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>lastOperations</span><span class=p>[</span><span class=nx>args</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>].</span><span class=nx>LastReply</span>
</span></span><span class=line><span class=cl>		<span class=nx>reply</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Err</span> <span class=p>=</span> <span class=nx>lastReply</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span> <span class=nx>lastReply</span><span class=p>.</span><span class=nx>Err</span>
</span></span><span class=line><span class=cl>		<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>index</span><span class=p>,</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>isLeader</span> <span class=o>:=</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>rf</span><span class=p>.</span><span class=nf>Start</span><span class=p>(</span><span class=nx>Command</span><span class=p>{</span><span class=nx>args</span><span class=p>})</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>!</span><span class=nx>isLeader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>reply</span><span class=p>.</span><span class=nx>Err</span> <span class=p>=</span> <span class=nx>ErrWrongLeader</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>ch</span> <span class=o>:=</span> <span class=nx>kv</span><span class=p>.</span><span class=nf>getNotifyCh</span><span class=p>(</span><span class=nx>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=nx>result</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>ch</span><span class=p>:</span>
</span></span><span class=line><span class=cl>		<span class=nx>reply</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Err</span> <span class=p>=</span> <span class=nx>result</span><span class=p>.</span><span class=nx>Value</span><span class=p>,</span> <span class=nx>result</span><span class=p>.</span><span class=nx>Err</span>
</span></span><span class=line><span class=cl>	<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>ExecuteTimeout</span><span class=p>):</span>
</span></span><span class=line><span class=cl>		<span class=nx>reply</span><span class=p>.</span><span class=nx>Err</span> <span class=p>=</span> <span class=nx>ErrTimeout</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=nx>kv</span><span class=p>.</span><span class=nf>deleteNotifyCh</span><span class=p>(</span><span class=nx>index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h4 id=223-applier class=heading-element><span>2.2.3 2.2.3 applier</span>
<a href=#223-applier class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h4><p><code>applier</code>协程实现如下，主要是监控<code>applyCh</code>，根据Raft的应用结果来进行响应处理，需要注意的就是检测是否为重复的命令，如果不是，则需要应用到状态机，并保存最近的响应结果。最后，如果当前节点是领导者，并且该日志条目属于当前任期，则通知相关的客户端。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>kv</span> <span class=o>*</span><span class=nx>KVServer</span><span class=p>)</span> <span class=nf>applier</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>kv</span><span class=p>.</span><span class=nf>killed</span><span class=p>()</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>message</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>kv</span><span class=p>.</span><span class=nx>applyCh</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node %v} tries to apply message %v&#34;</span><span class=p>,</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>rf</span><span class=p>.</span><span class=nf>GetId</span><span class=p>(),</span> <span class=nx>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>message</span><span class=p>.</span><span class=nx>CommandValid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>message</span><span class=p>.</span><span class=nx>CommandIndex</span> <span class=o>&lt;=</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>lastApplied</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node %v} discards outdated message %v because a newer snapshot which lastApplied is %v has been restored&#34;</span><span class=p>,</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>rf</span><span class=p>.</span><span class=nf>GetId</span><span class=p>(),</span> <span class=nx>message</span><span class=p>,</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>lastApplied</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=k>continue</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>kv</span><span class=p>.</span><span class=nx>lastApplied</span> <span class=p>=</span> <span class=nx>message</span><span class=p>.</span><span class=nx>CommandIndex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=nx>reply</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>CommandReply</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>command</span> <span class=o>:=</span> <span class=nx>message</span><span class=p>.</span><span class=nx>Command</span><span class=p>.(</span><span class=nx>Command</span><span class=p>)</span> <span class=c1>// type assertion
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>command</span><span class=p>.</span><span class=nx>Op</span> <span class=o>!=</span> <span class=nx>OpGet</span> <span class=o>&amp;&amp;</span> <span class=nx>kv</span><span class=p>.</span><span class=nf>isDuplicatedCommand</span><span class=p>(</span><span class=nx>command</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>,</span> <span class=nx>command</span><span class=p>.</span><span class=nx>CommandId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node %v} doesn&#39;t apply duplicated message %v to stateMachine because maxAppliedCommandId is %v for client %v&#34;</span><span class=p>,</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>rf</span><span class=p>.</span><span class=nf>GetId</span><span class=p>(),</span> <span class=nx>message</span><span class=p>,</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>lastOperations</span><span class=p>[</span><span class=nx>command</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>],</span> <span class=nx>command</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>reply</span> <span class=p>=</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>lastOperations</span><span class=p>[</span><span class=nx>command</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>].</span><span class=nx>LastReply</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>reply</span> <span class=p>=</span> <span class=nx>kv</span><span class=p>.</span><span class=nf>applyLogToStateMachine</span><span class=p>(</span><span class=nx>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>command</span><span class=p>.</span><span class=nx>Op</span> <span class=o>!=</span> <span class=nx>OpGet</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>kv</span><span class=p>.</span><span class=nx>lastOperations</span><span class=p>[</span><span class=nx>command</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>]</span> <span class=p>=</span> <span class=nx>OperationContext</span><span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>MaxAppliedCommandId</span><span class=p>:</span> <span class=nx>command</span><span class=p>.</span><span class=nx>CommandId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>LastReply</span><span class=p>:</span>           <span class=nx>reply</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=c1>// just notify related channel for currentTerm&#39;s log when node is leader
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>isLeader</span> <span class=o>:=</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>rf</span><span class=p>.</span><span class=nf>GetState</span><span class=p>();</span> <span class=nx>isLeader</span> <span class=o>&amp;&amp;</span> <span class=nx>message</span><span class=p>.</span><span class=nx>CommandTerm</span> <span class=o>==</span> <span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>ch</span> <span class=o>:=</span> <span class=nx>kv</span><span class=p>.</span><span class=nf>getNotifyCh</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>CommandIndex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=nx>reply</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=22-lab4b有快照 class=heading-element><span>2.3 2.2 lab4B：有快照</span>
<a href=#22-lab4b%e6%9c%89%e5%bf%ab%e7%85%a7 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>实现了lab4A，lab4B就好做了，只需要修改<code>applier</code>，每次应用了<code>command</code>之后，都需要检查是否达到<code>maxraftstate</code>，如果达到，则调用<code>snapshot</code>来制作快照，需要注意，快照中，不仅需要保存状态机的状态，还需要包含用来去重的<code>lastOperations</code>，这也是为了防止应用快照后的节点成为leader后，由于没有<code>lastOperations</code>导致重复执行命令。</p><p>然后，<code>applyCh</code>中还有Leader发来的快照，我们需要进行验证，如果有效，则需要更新相应的状态，具体实现代码如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>kv</span> <span class=o>*</span><span class=nx>KVServer</span><span class=p>)</span> <span class=nf>applier</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>kv</span><span class=p>.</span><span class=nf>killed</span><span class=p>()</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=nx>message</span> <span class=o>:=</span> <span class=o>&lt;-</span><span class=nx>kv</span><span class=p>.</span><span class=nx>applyCh</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node %v} tries to apply message %v&#34;</span><span class=p>,</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>rf</span><span class=p>.</span><span class=nf>GetId</span><span class=p>(),</span> <span class=nx>message</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>message</span><span class=p>.</span><span class=nx>CommandValid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>message</span><span class=p>.</span><span class=nx>CommandIndex</span> <span class=o>&lt;=</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>lastApplied</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node %v} discards outdated message %v because a newer snapshot which lastApplied is %v has been restored&#34;</span><span class=p>,</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>rf</span><span class=p>.</span><span class=nf>GetId</span><span class=p>(),</span> <span class=nx>message</span><span class=p>,</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>lastApplied</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>					<span class=k>continue</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>kv</span><span class=p>.</span><span class=nx>lastApplied</span> <span class=p>=</span> <span class=nx>message</span><span class=p>.</span><span class=nx>CommandIndex</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=nx>reply</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>CommandReply</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>command</span> <span class=o>:=</span> <span class=nx>message</span><span class=p>.</span><span class=nx>Command</span><span class=p>.(</span><span class=nx>Command</span><span class=p>)</span> <span class=c1>// type assertion
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>command</span><span class=p>.</span><span class=nx>Op</span> <span class=o>!=</span> <span class=nx>OpGet</span> <span class=o>&amp;&amp;</span> <span class=nx>kv</span><span class=p>.</span><span class=nf>isDuplicatedCommand</span><span class=p>(</span><span class=nx>command</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>,</span> <span class=nx>command</span><span class=p>.</span><span class=nx>CommandId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node %v} doesn&#39;t apply duplicated message %v to stateMachine because maxAppliedCommandId is %v for client %v&#34;</span><span class=p>,</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>rf</span><span class=p>.</span><span class=nf>GetId</span><span class=p>(),</span> <span class=nx>message</span><span class=p>,</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>lastOperations</span><span class=p>[</span><span class=nx>command</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>],</span> <span class=nx>command</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>reply</span> <span class=p>=</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>lastOperations</span><span class=p>[</span><span class=nx>command</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>].</span><span class=nx>LastReply</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>reply</span> <span class=p>=</span> <span class=nx>kv</span><span class=p>.</span><span class=nf>applyLogToStateMachine</span><span class=p>(</span><span class=nx>command</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>command</span><span class=p>.</span><span class=nx>Op</span> <span class=o>!=</span> <span class=nx>OpGet</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>kv</span><span class=p>.</span><span class=nx>lastOperations</span><span class=p>[</span><span class=nx>command</span><span class=p>.</span><span class=nx>ClientId</span><span class=p>]</span> <span class=p>=</span> <span class=nx>OperationContext</span><span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>MaxAppliedCommandId</span><span class=p>:</span> <span class=nx>command</span><span class=p>.</span><span class=nx>CommandId</span><span class=p>,</span>
</span></span><span class=line><span class=cl>							<span class=nx>LastReply</span><span class=p>:</span>           <span class=nx>reply</span><span class=p>,</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=c1>// just notify related channel for currentTerm&#39;s log when node is leader
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=k>if</span> <span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>isLeader</span> <span class=o>:=</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>rf</span><span class=p>.</span><span class=nf>GetState</span><span class=p>();</span> <span class=nx>isLeader</span> <span class=o>&amp;&amp;</span> <span class=nx>message</span><span class=p>.</span><span class=nx>CommandTerm</span> <span class=o>==</span> <span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>ch</span> <span class=o>:=</span> <span class=nx>kv</span><span class=p>.</span><span class=nf>getNotifyCh</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>CommandIndex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>ch</span> <span class=o>&lt;-</span> <span class=nx>reply</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>kv</span><span class=p>.</span><span class=nf>needSnapshot</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>kv</span><span class=p>.</span><span class=nf>takeSnapshot</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>CommandIndex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>				<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>message</span><span class=p>.</span><span class=nx>SnapshotValid</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>kv</span><span class=p>.</span><span class=nx>rf</span><span class=p>.</span><span class=nf>CondInstallSnapshot</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>SnapshotTerm</span><span class=p>,</span> <span class=nx>message</span><span class=p>.</span><span class=nx>SnapshotIndex</span><span class=p>,</span> <span class=nx>message</span><span class=p>.</span><span class=nx>Snapshot</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=nx>kv</span><span class=p>.</span><span class=nf>restoreStateFromSnapshot</span><span class=p>(</span><span class=nx>message</span><span class=p>.</span><span class=nx>Snapshot</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>kv</span><span class=p>.</span><span class=nx>lastApplied</span> <span class=p>=</span> <span class=nx>message</span><span class=p>.</span><span class=nx>SnapshotIndex</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=nx>kv</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nb>panic</span><span class=p>(</span><span class=nx>fmt</span><span class=p>.</span><span class=nf>Sprintf</span><span class=p>(</span><span class=s>&#34;Invalid ApplyMsg %v&#34;</span><span class=p>,</span> <span class=nx>message</span><span class=p>))</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=3-压测结果 class=heading-element><span>3 3 压测结果</span>
<a href=#3-%e5%8e%8b%e6%b5%8b%e7%bb%93%e6%9e%9c class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>网上提供了一个<a href=https://gist.github.com/JJGO/0d73540ef7cc2f066cb535156b7cbdab target=_blank rel="external nofollow noopener noreferrer">测试脚本<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>，功能强大。我的压测结果如下所示：</p><p><a class=lightgallery href="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240820095009785.png?size=large" data-thumbnail="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240820095009785.png?size=small" data-sub-html="<h2>image-20240820095009785</h2>"><img loading=lazy src=https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240820095009785.png alt=image-20240820095009785 srcset="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240820095009785.png?size=small, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240820095009785.png?size=medium 1.5x, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240820095009785.png?size=large 2x" data-title=image-20240820095009785 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p></div><hr class=awesome-hr><h2 id=see-also>相关内容</h2><ul><li><a href=/posts/08.mit-6.58406.824-lab3-raft/ title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现">【MIT 6.5840(6.824) 】Lab3:Raft 设计实现</a></li><li><a href=/posts/09.%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0grove/ title="【论文阅读笔记】Grove: A Separation-Logic Library for Verifying Distributed Systems (Extended Version)">【论文阅读笔记】Grove: A Separation-Logic Library for Verifying Distributed Systems (Extended Version)</a></li><li><a href=/posts/08.%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0zookeeper-wait-free-coordination-for-internet-scale-systems/ title="【论文阅读笔记】ZooKeeper: Wait-Free Coordination for Internet-Scale Systems">【论文阅读笔记】ZooKeeper: Wait-Free Coordination for Internet-Scale Systems</a></li><li><a href=/posts/07.raft/ title="【MIT 6.5840(6.824)学习笔记】Raft">【MIT 6.5840(6.824)学习笔记】Raft</a></li><li><a href=/posts/03.%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0in-search-of-an-understandable-consensus-algorithm-extended-version/ title="【论文阅读笔记】In Search of an Understandable Consensus Algorithm (Extended Version)">【论文阅读笔记】In Search of an Understandable Consensus Algorithm (Extended Version)</a></li></ul><div class=post-reward><div class=comment>Buy me a coffee~</div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=fixed><div><img loading=lazy src=/images/alipay.png alt="HeZephyr 支付宝" data-title="HeZephyr 支付宝" style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span data-animation>支付宝</span></div><div><img loading=lazy src=/images/wechatpay.jpg alt="HeZephyr 微信" data-title="HeZephyr 微信" style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span data-animation>微信</span></div></div></div><div class=collection-card><div class="collection-title text-secondary">收录于 <a href=/collections/mit-6.5840/><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> <span>合集・MIT 6.5840</span></span></a> 9</div><div class=collection-nav><a href=/posts/08.mit-6.58406.824-lab3-raft/ class=collection-nav-item rel=prev title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i><span>【MIT 6.5840(6.824) 】Lab3:Raft 设计实现</span></a></div></div><div class=collection-card><div class="collection-title text-secondary">收录于 <a href=/collections/%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5/><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> <span>合集・动手实践</span></span></a> 4</div><div class=collection-nav><a href=/posts/08.mit-6.58406.824-lab3-raft/ class=collection-nav-item rel=prev title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i><span>【MIT 6.5840(6.824) 】Lab3:Raft 设计实现</span></a></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2024-08-30 22:55:44">更新于 2024-08-30&nbsp;
<a class=git-hash href=https://github.com/HeZephyr/HeZephyr.github.io/commit/629c3836503e18a21976d13b8f7bbce8f6ae0d4d rel="external nofollow noopener noreferrer" target=_blank title="commit by zfhe(2825841950@qq.com) 629c3836503e18a21976d13b8f7bbce8f6ae0d4d: :pencil: Docs: Zephyr's Note update 2024-08-30 五 22:55:44"><i class="fa-solid fa-hashtag fa-fw" aria-hidden=true></i>629c383</a></span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span><span><a href="https://github.com/HeZephyr/HeZephyr.github.io/blob/docs/content/posts/_develop/_system/distributed_system/09.MIT%206.5840%286.824%29%20Lab4%20Fault-tolerant%20KVService.md?plain=1" title=查看源码 target=_blank rel="external nofollow noopener noreferrer" class=link-to-source>查看源码</a></span><span><a href=https://github.com/HeZephyr/HeZephyr.github.io/edit/docs/content/posts/_develop/_system/distributed_system/09.MIT%206.5840%286.824%29%20Lab4%20Fault-tolerant%20KVService.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span><span><a href="https://github.com/HeZephyr/HeZephyr.github.io/issues/new?title=[BUG]%20%E3%80%90MIT+6.5840%286.824%29%E3%80%91+Lab+4%3AFault-tolerant+KVService+%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7c%E3%80%90MIT+6.5840%286.824%29%E3%80%91+Lab+4%3AFault-tolerant+KVService+%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0%7c%0A%7cURL%7chttps://hezephyr.github.io/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/%7c%0A%7cFilename%7chttps://github.com/HeZephyr/HeZephyr.github.io/blob/docs/content/posts/_develop/_system/distributed_system/09.MIT%206.5840%286.824%29%20Lab4%20Fault-tolerant%20KVService.md?plain=1%7c" title=报告问题 target=_blank rel="external nofollow noopener noreferrer" class=link-to-report>报告问题</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=twitter data-url=https://hezephyr.github.io/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/ data-title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现" data-hashtags=分布式系统><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://hezephyr.github.io/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/ data-hashtag=分布式系统><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://hezephyr.github.io/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://hezephyr.github.io/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/ data-title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://hezephyr.github.io/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/ data-title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现"><i data-svg-src=https://unpkg.com/simple-icons@9.19.0/icons/baidu.svg aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/ class=post-tag title="标签 - 分布式系统">分布式系统</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/09.%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0grove/ class=post-nav-item rel=next title="【论文阅读笔记】Grove: A Separation-Logic Library for Verifying Distributed Systems (Extended Version)">【论文阅读笔记】Grove: A Separation-Logic Library for Verifying Distributed Systems (Extended Version)<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=HeZephyr/HeZephyr.github.io data-repo-id=R_kgDOMb2HgQ data-category=General data-category-id=DIC_kwDOMb2Hgc4ChPAb data-mapping=title data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered order-1">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.133.1"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.9-RC"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright order-2" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2020 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/HeZephyr target=_blank rel="external nofollow noopener noreferrer">HeZephyr</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div><div class="footer-line statistics"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="ms-1 d-none">博客已运行</span><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-first"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/HeZephyr title="View on GitHub" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:#8581dd;--bg-progress-dark:#fff></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=https://unpkg.com/lightgallery@2.7.2/css/lightgallery-bundle.min.css><link rel=preload href=https://unpkg.com/katex@0.16.10/dist/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/katex@0.16.10/dist/katex.min.css></noscript><link rel=stylesheet href=https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.css><link rel=stylesheet href=https://unpkg.com/pace-js@1.2.4/themes/blue/pace-theme-minimal.css><script src=https://unpkg.com/autocomplete.js@0.38.1/dist/autocomplete.min.js defer></script><script src=https://unpkg.com/algoliasearch@4.20.0/dist/algoliasearch-lite.umd.js defer></script><script src=https://unpkg.com/instant.page@5.2.0/instantpage.js async defer type=module></script><script src=https://unpkg.com/lightgallery@2.7.2/lightgallery.min.js defer></script><script src=https://unpkg.com/lightgallery@2.7.2/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=https://unpkg.com/lightgallery@2.7.2/plugins/zoom/lg-zoom.min.js defer></script><script src=https://unpkg.com/sharer.js@0.5.1/sharer.min.js async defer></script><script src=https://unpkg.com/katex@0.16.10/dist/katex.min.js defer></script><script src=https://unpkg.com/katex@0.16.10/dist/contrib/auto-render.min.js defer></script><script src=https://unpkg.com/katex@0.16.10/dist/contrib/copy-tex.min.js defer></script><script src=https://unpkg.com/katex@0.16.10/dist/contrib/mhchem.min.js defer></script><script src=https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.js defer></script><script src=https://unpkg.com/pangu@4.0.7/dist/browser/pangu.min.js defer></script><script src=https://unpkg.com/cell-watermark@1.0.3/src/watermark.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=https://unpkg.com/pace-js@1.2.4/pace.min.js async defer></script><script src=/js/flyfish.js defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:50},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark_dimmed",lightTheme:"light",origin:"https://giscus.app"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!0,left:"$$",right:"$$"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"},{display:!1,left:"$",right:"$"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{algoliaAppID:"LKM6MKQ6NB",algoliaIndex:"index",algoliaSearchKey:"c9bb91e3a1318f3c9efae98daa87bca5",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},siteTime:"2020-06-10T15:42:01+08:00",version:"v0.3.9-RC",watermark:{colspacing:30,content:'<img style="height: 0.85rem;" src="/logo.png" alt="logo" /> 贺志飞',enable:!0,fontfamily:"LiuJianMaoCao-Regular, 钟齐流江毛草",fontsize:1.1,height:20,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script></body></html>