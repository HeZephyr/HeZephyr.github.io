<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>【MIT 6.5840(6.824) 】Lab3:Raft 设计实现 | ZephyrHe</title><meta name=author content="HeZephyr">
<meta name=author-link content="https://github.com/HeZephyr"><meta name=description content="1 实验要求
  
    
  
在本实验中，要求实现Raft，这是一种复制状态机协议，用于构建一个容错的键/值存储系统。实验的具体要求如下："><meta name=keywords content='分布式系统'><meta itemprop=name content="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现"><meta itemprop=description content="1 实验要求 在本实验中，要求实现Raft，这是一种复制状态机协议，用于构建一个容错的键/值存储系统。实验的具体要求如下："><meta itemprop=datePublished content="2024-08-11T00:00:00+00:00"><meta itemprop=dateModified content="2024-10-15T18:55:47+08:00"><meta itemprop=wordCount content="7100"><meta itemprop=image content="https://hezephyr.github.io/images/apple-devices-preview.webp"><meta itemprop=keywords content="分布式系统"><meta property="og:url" content="https://hezephyr.github.io/posts/08.mit-6.58406.824-lab3-raft/"><meta property="og:site_name" content="ZephyrHe"><meta property="og:title" content="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现"><meta property="og:description" content="1 实验要求 在本实验中，要求实现Raft，这是一种复制状态机协议，用于构建一个容错的键/值存储系统。实验的具体要求如下："><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-08-11T00:00:00+00:00"><meta property="article:modified_time" content="2024-10-15T18:55:47+08:00"><meta property="article:tag" content="分布式系统"><meta property="og:image" content="https://hezephyr.github.io/images/apple-devices-preview.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hezephyr.github.io/images/apple-devices-preview.webp"><meta name=twitter:title content="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现"><meta name=twitter:description content="1 实验要求 在本实验中，要求实现Raft，这是一种复制状态机协议，用于构建一个容错的键/值存储系统。实验的具体要求如下："><meta name=application-name content="Zephyr's Blog"><meta name=apple-mobile-web-app-title content="Zephyr's Blog"><meta name=theme-color data-light=#ffffff data-dark=#252627 content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://hezephyr.github.io/posts/08.mit-6.58406.824-lab3-raft/><link rel=prev href=https://hezephyr.github.io/posts/08.%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0zookeeper-wait-free-coordination-for-internet-scale-systems/><link rel=next href=https://hezephyr.github.io/posts/09.%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0grove/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://unpkg.com/@fortawesome/fontawesome-free@6.4.2/css/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@6.4.2/css/all.min.css></noscript><link rel=preload href=https://unpkg.com/animate.css@4.1.1/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"【MIT 6.5840(6.824) 】Lab3:Raft 设计实现","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/hezephyr.github.io\/posts\/08.mit-6.58406.824-lab3-raft\/"},"image":[{"@type":"ImageObject","url":"https:\/\/hezephyr.github.io\/images\/apple-devices-preview.webp","width":2880,"height":1508}],"genre":"posts","keywords":"分布式系统","wordcount":7100,"url":"https:\/\/hezephyr.github.io\/posts\/08.mit-6.58406.824-lab3-raft\/","datePublished":"2024-08-11T00:00:00+00:00","dateModified":"2024-10-15T18:55:47+08:00","license":"本站内容采用 CC BY-NC-SA 4.0 国际许可协议。","publisher":{"@type":"Organization","name":"Lruihao","logo":"https:\/\/hezephyr.github.io\/images\/avatar.jpg"},"author":{"@type":"Person","name":"HeZephyr"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title=ZephyrHe><img loading=lazy src=/images/logo.png alt=ZephyrHe data-title=ZephyrHe width=26 height=26 class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>HeZephyr</span></a><span class=header-subtitle>贺志飞的博客</span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=ZephyrHe><img loading=lazy src=/images/logo.png alt=ZephyrHe data-title=ZephyrHe width=26 height=26 class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>HeZephyr</span></a><span class=header-subtitle>贺志飞的博客</span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item text-center"><a class=menu-link href=https://github.com/HeZephyr/HeZephyr.github.io title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item><a href=/posts/ title=Posts>文章</a></li><li class="breadcrumb-item active" aria-current=page>【MIT 6.5840(6.824) 】Lab3:Raft 设计实现</li></ol></nav><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集><div class="details collection-details open"><div class="details-summary collection-summary"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i>
<span class=collection-name data-collections=合集>MIT 6.5840</span>
<span class=collection-count>10</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content collection-content"><nav><ul class=collection-list><li class=collection-item><a href=/posts/01.%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E4%BB%8B%E7%BB%8D/ title="【MIT 6.5840(6.824)学习笔记】 分布式系统介绍">【MIT 6.5840(6.824)学习笔记】 分布式系统介绍</a></li><li class=collection-item><a href=/posts/05.mit-6.58406.824-lab1mapreduce-%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/ title="【MIT 6.5840(6.824)】Lab1:MapReduce 设计实现">【MIT 6.5840(6.824)】Lab1:MapReduce 设计实现</a></li><li class=collection-item><a href=/posts/06.mit-6.58406.824-lab2-kv-server/ title="【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现">【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现</a></li><li class=collection-item><a href=/posts/02.%E4%BD%BF%E7%94%A8go%E8%BF%9B%E8%A1%8C%E7%BA%BF%E7%A8%8B%E5%92%8Crpc%E7%BC%96%E7%A8%8B/ title="【MIT 6.5840(6.824)学习笔记】使用Go进行线程和RPC编程">【MIT 6.5840(6.824)学习笔记】使用Go进行线程和RPC编程</a></li><li class=collection-item><a href=/posts/03.%E6%B5%8B%E8%AF%95%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%BA%BF%E6%80%A7%E4%B8%80%E8%87%B4%E6%80%A7/ title="【MIT 6.5840(6.824)学习笔记】 测试分布式系统的线性一致性">【MIT 6.5840(6.824)学习笔记】 测试分布式系统的线性一致性</a></li><li class=collection-item><a href=/posts/04.gfs/ title="【MIT 6.5840(6.824)学习笔记】GFS">【MIT 6.5840(6.824)学习笔记】GFS</a></li><li class=collection-item><a href=/posts/07.raft/ title="【MIT 6.5840(6.824)学习笔记】Raft">【MIT 6.5840(6.824)学习笔记】Raft</a></li><li class=collection-item><span class=active title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现">【MIT 6.5840(6.824) 】Lab3:Raft 设计实现</span></li><li class=collection-item><a href=/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/ title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现">【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现</a></li><li class=collection-item><a href=/posts/11.mit6.5840-lab5/ title="【MIT 6.5840(6.824)】 Lab 5:Sharded Key/Value Service 设计实现">【MIT 6.5840(6.824)】 Lab 5:Sharded Key/Value Service 设计实现</a></li></ul><div class=collection-nav-simple><a href=/posts/07.raft/ class=collection-nav-item rel=prev title="【MIT 6.5840(6.824)学习笔记】Raft"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i></a><span class=text-secondary>8/10</span><a href=/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/ class=collection-nav-item rel=next title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现"><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></nav></div></div><div class="details collection-details"><div class="details-summary collection-summary"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i>
<span class=collection-name data-collections=合集>动手实践</span>
<span class=collection-count>5</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content collection-content"><nav><ul class=collection-list><li class=collection-item><a href=/posts/05.mit-6.58406.824-lab1mapreduce-%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0/ title="【MIT 6.5840(6.824)】Lab1:MapReduce 设计实现">【MIT 6.5840(6.824)】Lab1:MapReduce 设计实现</a></li><li class=collection-item><a href=/posts/06.mit-6.58406.824-lab2-kv-server/ title="【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现">【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现</a></li><li class=collection-item><span class=active title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现">【MIT 6.5840(6.824) 】Lab3:Raft 设计实现</span></li><li class=collection-item><a href=/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/ title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现">【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现</a></li><li class=collection-item><a href=/posts/11.mit6.5840-lab5/ title="【MIT 6.5840(6.824)】 Lab 5:Sharded Key/Value Service 设计实现">【MIT 6.5840(6.824)】 Lab 5:Sharded Key/Value Service 设计实现</a></li></ul><div class=collection-nav-simple><a href=/posts/06.mit-6.58406.824-lab2-kv-server/ class=collection-nav-item rel=prev title="【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i></a><span class=text-secondary>3/5</span><a href=/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/ class=collection-nav-item rel=next title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现"><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></nav></div></div></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>【MIT 6.5840(6.824) 】Lab3:Raft 设计实现</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/HeZephyr title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img loading=lazy src="https://cn.gravatar.com/avatar/65f6ab71abcb9d540eb32a2704884927?s=32&amp;d=mp" alt=HeZephyr data-title=HeZephyr width=20 height=20 class=avatar style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'>&nbsp;HeZephyr</a></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/ class=post-category title="分类 - 系统架构"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 系统架构</a> 和 <a href=/collections/mit-6.5840/ class=post-collection title="合集 - MIT 6.5840"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> MIT 6.5840</a>&ensp;<a href=/collections/%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5/ class=post-collection title="合集 - 动手实践"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> 动手实践</a></span></div><div class=post-meta-line><span title="发布于 2024-08-11 00:00:00"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-08-11>2024-08-11</time></span>&nbsp;<span title="更新于 2024-10-15 18:55:47"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2024-10-15>2024-10-15</time></span>&nbsp;<span title="7100 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 7200 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 15 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现">
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#实验要求>实验要求</a></li><li><a href=#实验设计>实验设计</a><ol><li><a href=#整体结构>整体结构</a></li><li><a href=#lab3a领导者选举>lab3A：领导者选举</a></li><li><a href=#lab3b日志>lab3B：日志</a></li><li><a href=#lab3c持久化>lab3C：持久化</a></li><li><a href=#lab3d日志压缩>lab3D：日志压缩</a></li></ol></li><li><a href=#压测脚本>压测脚本</a></li><li><a href=#优化>优化</a></li></ol></nav></div></div><div class=content id=content data-end-flag="「本文完，更多内容汇总在我的 GitHub与CSDN，持续更新，求关注、求 star、求订阅！」"><h2 id=实验要求 class=heading-element><span>1 实验要求</span>
<a href=#%e5%ae%9e%e9%aa%8c%e8%a6%81%e6%b1%82 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>在本实验中，要求实现Raft，这是一种复制状态机协议，用于构建一个容错的键/值存储系统。实验的具体要求如下：</p><ol><li><strong>实现Raft</strong>：<ul><li>将Raft实现为一个Go语言的对象类型，包含相关的方法，以便作为更大服务的一个模块使用。</li><li>Raft实例之间通过RPC通信，以维持复制的日志一致性。</li><li>支持无限数量的编号命令（日志条目），并能处理这些条目的提交。当一个特定索引的日志条目被提交后，Raft实现应将该条目发送给更大的服务执行。</li></ul></li><li><strong>遵循论文设计</strong>：<ul><li>遵循<a href=https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf target=_blank rel="external nofollow noopener noreferrer">Raft论文<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>的设计，重点参考图2。</li><li>实现论文中描述的大部分功能，包括持久状态的保存和恢复，即使在节点故障和重启后也能保证数据的完整性。</li><li>不需要实现集群成员变更的部分（论文第六节）。</li></ul></li></ol><p>论文图2:</p><p><a class=lightgallery href="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160616514.png?size=large" data-thumbnail="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160616514.png?size=small" data-sub-html="<h2>image-20240811160616514</h2>"><img loading=lazy src=https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160616514.png alt=image-20240811160616514 srcset="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160616514.png?size=small, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160616514.png?size=medium 1.5x, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160616514.png?size=large 2x" data-title=image-20240811160616514 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><p>Raft交互图：</p><p><a class=lightgallery href="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png?size=large" data-thumbnail="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png?size=small" data-sub-html="<h2>image-20240811160802518</h2>"><img loading=lazy src=https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png alt=image-20240811160802518 srcset="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png?size=small, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png?size=medium 1.5x, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811160802518.png?size=large 2x" data-title=image-20240811160802518 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><p>我的实验代码仓库：https://github.com/HeZephyr/MIT6.5840/tree/main/src/raft，已通过压力测试，代码严格遵守上述按要求实现。</p><p><font color=red>注意：下述所贴代码为了简洁以及分块，进行了一定程度的删减，如果需要复现，可以前往仓库</font>。</p><h2 id=实验设计 class=heading-element><span>2 实验设计</span>
<a href=#%e5%ae%9e%e9%aa%8c%e8%ae%be%e8%ae%a1 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><h3 id=整体结构 class=heading-element><span>2.1 整体结构</span>
<a href=#%e6%95%b4%e4%bd%93%e7%bb%93%e6%9e%84 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>此Raft结构体基于论文图2，基本上都是其中介绍的字段以及lab自带的字段，其中其他属性论文中也间接简述和支持，以确保Raft节点能够高效、稳定地运作。如选举定时器和心跳定时器，被明确地纳入了Raft结构体中。这些定时器对于触发关键的系统行为至关重要——选举定时器确保在必要时发起选举过程，而心跳定时器则维持着领导者与跟随者之间的连接，防止不必要的选举。</p><p>条件变量（<code>sync.Cond</code>）的引入则是为了精妙地控制两个核心后台goroutine的操作节奏：日志应用goroutine（<code>applier</code>，只需要一个，<font color=red>专门用于监控日志条目的提交状态，一旦日志条目被确认提交，它将负责将这些条目应用到状态机中</font>。）和日志复制goroutine（<code>replicator</code>，<font color=red>负责进行日志条目的同步</font>。考虑到集群中每个peer都需要与除了自身以外的其它peer进行日志同步，这意味着我们需要<code>len(peers) - 1</code>个<code>replicator</code> goroutines来分别处理与每个peer的交互）。</p><p>此外，还有一个goroutine <code>ticker</code>负责定期检查选举和心跳的超时，确保在适当的时间间隔内触发选举过程或发送心跳信号。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span><span class=lnt>64
</span><span class=lnt>65
</span><span class=lnt>66
</span><span class=lnt>67
</span><span class=lnt>68
</span><span class=lnt>69
</span><span class=lnt>70
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Raft</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>mu</span>        <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span>        <span class=c1>// Lock to protect shared access to this peer&#39;s state, to use RWLock for better performance
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>peers</span>     <span class=p>[]</span><span class=o>*</span><span class=nx>labrpc</span><span class=p>.</span><span class=nx>ClientEnd</span> <span class=c1>// RPC end points of all peers
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>persister</span> <span class=o>*</span><span class=nx>Persister</span>          <span class=c1>// Object to hold this peer&#39;s persisted state
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>me</span>        <span class=kt>int</span>                 <span class=c1>// this peer&#39;s index into peers[]
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>dead</span>      <span class=kt>int32</span>               <span class=c1>// set by Kill()
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Persistent state on all servers(Updated on stable storage before responding to RPCs)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>currentTerm</span> <span class=kt>int</span>        <span class=c1>// latest term server has seen(initialized to 0 on first boot, increases monotonically)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>votedFor</span>    <span class=kt>int</span>        <span class=c1>// candidateId that received vote in current term(or null if none)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>logs</span>        <span class=p>[]</span><span class=nx>LogEntry</span> <span class=c1>// log entries; each entry contains command for state machine, and term when entry was received by leader(first index is 1)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Volatile state on all servers
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>commitIndex</span> <span class=kt>int</span> <span class=c1>// index of highest log entry known to be committed(initialized to 0, increases monotonically)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>lastApplied</span> <span class=kt>int</span> <span class=c1>// index of highest log entry applied to state machine(initialized to 0, increases monotonically)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Volatile state on leaders(Reinitialized after election)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>nextIndex</span>  <span class=p>[]</span><span class=kt>int</span> <span class=c1>// for each server, index of the next log entry to send to that server(initialized to leader last log index + 1)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>matchIndex</span> <span class=p>[]</span><span class=kt>int</span> <span class=c1>// for each server, index of highest log entry known to be replicated on server(initialized to 0, increases monotonically)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// other properties
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>state</span>          <span class=nx>NodeState</span>     <span class=c1>// current state of the server
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>electionTimer</span>  <span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Timer</span>   <span class=c1>// timer for election timeout
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>heartbeatTimer</span> <span class=o>*</span><span class=nx>time</span><span class=p>.</span><span class=nx>Timer</span>   <span class=c1>// timer for heartbeat
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>applyCh</span>        <span class=kd>chan</span> <span class=nx>ApplyMsg</span> <span class=c1>// channel to send apply message to service
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>applyCond</span>      <span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span>    <span class=c1>// condition variable for apply goroutine
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>replicatorCond</span> <span class=p>[]</span><span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span>  <span class=c1>// condition variable for replicator goroutine
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>Make</span><span class=p>(</span><span class=nx>peers</span> <span class=p>[]</span><span class=o>*</span><span class=nx>labrpc</span><span class=p>.</span><span class=nx>ClientEnd</span><span class=p>,</span> <span class=nx>me</span> <span class=kt>int</span><span class=p>,</span>
</span></span><span class=line><span class=cl>	<span class=nx>persister</span> <span class=o>*</span><span class=nx>Persister</span><span class=p>,</span> <span class=nx>applyCh</span> <span class=kd>chan</span> <span class=nx>ApplyMsg</span><span class=p>)</span> <span class=o>*</span><span class=nx>Raft</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span> <span class=o>:=</span> <span class=o>&amp;</span><span class=nx>Raft</span><span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>mu</span><span class=p>:</span>             <span class=nx>sync</span><span class=p>.</span><span class=nx>RWMutex</span><span class=p>{},</span>
</span></span><span class=line><span class=cl>		<span class=nx>peers</span><span class=p>:</span>          <span class=nx>peers</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>persister</span><span class=p>:</span>      <span class=nx>persister</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>me</span><span class=p>:</span>             <span class=nx>me</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>dead</span><span class=p>:</span>           <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>currentTerm</span><span class=p>:</span>    <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>votedFor</span><span class=p>:</span>       <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>logs</span><span class=p>:</span>           <span class=nb>make</span><span class=p>([]</span><span class=nx>LogEntry</span><span class=p>,</span> <span class=mi>1</span><span class=p>),</span> <span class=c1>// dummy entry at index 0
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>commitIndex</span><span class=p>:</span>    <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>lastApplied</span><span class=p>:</span>    <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>nextIndex</span><span class=p>:</span>      <span class=nb>make</span><span class=p>([]</span><span class=kt>int</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>peers</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>matchIndex</span><span class=p>:</span>     <span class=nb>make</span><span class=p>([]</span><span class=kt>int</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>peers</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>		<span class=nx>state</span><span class=p>:</span>          <span class=nx>Follower</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>electionTimer</span><span class=p>:</span>  <span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=nf>RandomElectionTimeout</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=nx>heartbeatTimer</span><span class=p>:</span> <span class=nx>time</span><span class=p>.</span><span class=nf>NewTimer</span><span class=p>(</span><span class=nf>StableHeartbeatTimeout</span><span class=p>()),</span>
</span></span><span class=line><span class=cl>		<span class=nx>applyCh</span><span class=p>:</span>        <span class=nx>applyCh</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=nx>replicatorCond</span><span class=p>:</span> <span class=nb>make</span><span class=p>([]</span><span class=o>*</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Cond</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>peers</span><span class=p>)),</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// initialize from state persisted before a crash
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rf</span><span class=p>.</span><span class=nf>readPersist</span><span class=p>(</span><span class=nx>persister</span><span class=p>.</span><span class=nf>ReadRaftState</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=c1>// should use mu to protect applyCond, avoid other goroutine to change the critical section
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rf</span><span class=p>.</span><span class=nx>applyCond</span> <span class=p>=</span> <span class=nx>sync</span><span class=p>.</span><span class=nf>NewCond</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// initialize nextIndex and matchIndex, and start replicator goroutine
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>for</span> <span class=nx>peer</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>peers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>matchIndex</span><span class=p>[</span><span class=nx>peer</span><span class=p>],</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>nextIndex</span><span class=p>[</span><span class=nx>peer</span><span class=p>]</span> <span class=p>=</span> <span class=mi>0</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getLastLog</span><span class=p>().</span><span class=nx>Index</span><span class=o>+</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>peer</span> <span class=o>!=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>replicatorCond</span><span class=p>[</span><span class=nx>peer</span><span class=p>]</span> <span class=p>=</span> <span class=nx>sync</span><span class=p>.</span><span class=nf>NewCond</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>sync</span><span class=p>.</span><span class=nx>Mutex</span><span class=p>{})</span>
</span></span><span class=line><span class=cl>			<span class=c1>// start replicator goroutine to send log entries to peer
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=k>go</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>replicator</span><span class=p>(</span><span class=nx>peer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// start ticker goroutine to start elections
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>ticker</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// start apply goroutine to apply log entries to state machine
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>go</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>applier</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>rf</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=lab3a领导者选举 class=heading-element><span>2.2 lab3A：领导者选举</span>
<a href=#lab3a%e9%a2%86%e5%af%bc%e8%80%85%e9%80%89%e4%b8%be class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>此任务需要实现Raft领导人选举和心跳（通过不附加日志条目的RPC）。对于这个要求，论文中其实给出了状态转移图，指导我们怎么去做。这个选举流程逻辑如下：</p><p><a class=lightgallery href="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader?size=large" data-thumbnail="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader?size=small" data-sub-html="<h2>image-20240811140525050</h2>"><img loading=lazy src=https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader alt=image-20240811140525050 srcset="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader?size=small, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader?size=medium 1.5x, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader?size=large 2x" data-title=image-20240811140525050 class="suffix-invalid suffix-invalid__small suffix-invalid__large" style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><blockquote><p>在lab3A实现过程中，需要注意如下几点：</p><ul><li>当发起投票时，务必使用goroutine并行发起RPC调用，以避免阻塞<code>ticker</code>协程。这样，即使在等待投票响应期间，候选者（Candidate）仍能响应新的选举超时，从而有机会自增任期并启动新一轮的选举。</li><li>有两种常见的实现投票统计的方式：一种是在函数作用域内定义一个局部变量，并利用闭包来维护投票计数；另一种是在<code>Raft</code>结构体中维护一个全局的<code>voteCnt</code>变量。为了保持<code>Raft</code>结构体的简洁，推荐采用局部变量和闭包的方案。</li><li>对于过期的RPC请求回复，应直接忽略，不作任何处理。这是因为Raft协议假设网络环境不可靠，可能发生的延迟或重播不应影响当前的决策流程。</li><li>如果在RPC通信中，节点A发现其任期小于节点B的任期，不论节点A当前的角色如何，都应立即转换为跟随者（Follower）。这是为了维护任期的权威性，确保集群的一致性。</li><li>为防止多个节点几乎同时启动选举，导致资源浪费和潜在的领导权争夺，应为选举超时设置一个随机的误差范围（如150~300ms），以拉长不同节点选举的时间间隔，这里采用时间戳作为随机种子。<font color=red>且每一次一个节点重置自己的选举定时器时，都需要重新选择一个随机的超时时间。避免服务器会以极小的概率选择相同的随机超时时间，那么会永远处于分割选票的场景中</font>。</li><li>Go RPC 仅发送名称以大写字母开头的结构体字段。子结构还必须具有大写的字段名称（例如数组中日志记录的字段）。这 <code>labgob</code> 软件包会警告您这一点；不要忽视警告。</li><li>在同一个任期内，Follower只能投出一票，这是为了防止出现多个Leader的情况。票数的刷新应在任期转换时进行，以确保投票的有效性和一致性。</li><li>为了提高并发性能，应尽量缩短临界区的长度。合理的锁使用策略是只在真正需要保护共享资源的最小时间内使用锁。</li></ul></blockquote><p>核心的Ticker实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>ticker</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>killed</span><span class=p>()</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nf>ChangeState</span><span class=p>(</span><span class=nx>Candidate</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>			<span class=c1>// start election
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>rf</span><span class=p>.</span><span class=nf>StartElection</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>RandomElectionTimeout</span><span class=p>())</span> <span class=c1>// reset election timer in case of split vote
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>rf</span><span class=p>.</span><span class=nx>heartbeatTimer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>Leader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=c1>// should send heartbeat
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>rf</span><span class=p>.</span><span class=nf>BroadcastHeartbeat</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>rf</span><span class=p>.</span><span class=nx>heartbeatTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>StableHeartbeatTimeout</span><span class=p>())</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>StartElection</code>函数实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>StartElection</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span>
</span></span><span class=line><span class=cl>	<span class=nx>args</span> <span class=o>:=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>genRequestVoteArgs</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>grantedVotes</span> <span class=o>:=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>peer</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>peers</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>peer</span> <span class=o>==</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>continue</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>go</span> <span class=kd>func</span><span class=p>(</span><span class=nx>peer</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>reply</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>RequestVoteReply</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>sendRequestVote</span><span class=p>(</span><span class=nx>peer</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=nx>reply</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=o>==</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>Candidate</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>grantedVotes</span> <span class=o>+=</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>						<span class=c1>// check over half of the votes
</span></span></span><span class=line><span class=cl><span class=c1></span>						<span class=k>if</span> <span class=nx>grantedVotes</span> <span class=p>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>peers</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=nx>rf</span><span class=p>.</span><span class=nf>ChangeState</span><span class=p>(</span><span class=nx>Leader</span><span class=p>)</span>
</span></span><span class=line><span class=cl>							<span class=nx>rf</span><span class=p>.</span><span class=nf>BroadcastHeartbeat</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>rf</span><span class=p>.</span><span class=nf>ChangeState</span><span class=p>(</span><span class=nx>Follower</span><span class=p>)</span>
</span></span><span class=line><span class=cl>						<span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=p>=</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}(</span><span class=nx>peer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>RequestVote</code>RPC严格按照图2描述实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>RequestVote</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>RequestVoteArgs</span><span class=p>,</span> <span class=nx>reply</span> <span class=o>*</span><span class=nx>RequestVoteReply</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node %v}&#39;s state is {state %v, term %v}} after processing RequestVote,  RequestVoteArgs %v and RequestVoteReply %v &#34;</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>state</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=nx>reply</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Reply false if term &lt; currentTerm(§5.1)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// if the term is same as currentTerm, and the votedFor is not null and not the candidateId, then reject the vote(§5.2)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&lt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=o>||</span> <span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=o>==</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=o>!=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>CandidateId</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nf>ChangeState</span><span class=p>(</span><span class=nx>Follower</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// if candidate&#39;s log is not up-to-date, reject the vote(§5.4)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>rf</span><span class=p>.</span><span class=nf>isLogUpToDate</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>LastLogIndex</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>LastLogTerm</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>CandidateId</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>RandomElectionTimeout</span><span class=p>())</span>
</span></span><span class=line><span class=cl>	<span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=lab3b日志 class=heading-element><span>2.3 lab3B：日志</span>
<a href=#lab3b%e6%97%a5%e5%bf%97 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>在Lab3B阶段，我们的目标转向实现Raft协议中至关重要的日志复制机制。其中入口是<code>Start</code>函数（应用程序与Raft的接口）。具体的日志复制流程：</p><ul><li>一旦Leader接收到新的日志条目，它首先会在自己的日志中追加这个条目。</li><li>随后，Leader通过<code>BroadcastHeartbeat</code>函数将这个日志条目广播至集群中的所有Peer，确保所有节点都能同步最新的状态。此过程涉及对日志条目的校验与冲突解决，确保每个Peer的日志保持一致且最新。</li><li>在日志条目被发送给Peers后，Leader会等待来自Peer的确认回复。只有当Leader收到大多数Peer（即超过半数）的确认，表明这些Peer已经成功复制了日志条目，Leader才能认为该日志条目已经被安全地复制。这是Raft协议中“多数原则”的体现，确保了即使在部分节点失败的情况下，系统仍然能够达成一致。<font color=red>当然，也需要根据回复确认自己Leader的地位，如果不再是Leader，需要更改为Follower</font>。</li><li>一旦日志条目被确认复制到了大多数节点，Leader就会标记这个条目为已提交（committed）。随后，Leader会通过<code>AppendEntries</code> RPC将最新的<code>LeaderCommit</code>信息广播给所有Peer，指示它们哪些日志条目现在可以被提交并应用到各自的状态机中。每个Peer根据接收到的<code>LeaderCommit</code>值来决定其日志中哪些条目可以被提交，从而确保所有活跃Peer的状态机保持一致。</li></ul><p><a class=lightgallery href="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader_election?size=large" data-thumbnail="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader_election?size=small" data-sub-html="<h2>image-20240811144321194</h2>"><img loading=lazy src=https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader_election alt=image-20240811144321194 srcset="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader_election?size=small, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader_election?size=medium 1.5x, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/leader_election?size=large 2x" data-title=image-20240811144321194 class="suffix-invalid suffix-invalid__small suffix-invalid__large" style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><blockquote><p>在lab3B实现过程中，需要注意如下几点：</p><ul><li>在发送RPC、接收RPC、推送和接收channel时，绝对不要持有锁，否则极易引发死锁。这在locking博客中有详细介绍，应时刻牢记。<font color=red>使用读写锁时，对于只读操作，只需持有读锁，避免不必要的写锁持有，以提高并发性能</font>。</li><li>对于过期的RPC请求回复，应直接忽略，避免执行任何业务逻辑</li><li>根据图2的规定，Raft Leader只能提交属于当前任期的日志条目，不得提交前任期的日志。在根据<code>matchIndex[]</code>判断是否可以提交日志时，必须检查该日志的任期是否与当前Leader的任期相匹配。</li><li>Follower对Leader的<code>leaderCommit</code>应无条件服从，无需额外判断。</li><li>Leader需维护好<code>matchIndex[]</code>（跟踪Follower的提交状态）和<code>nextIndex[]</code>（追踪Follower的日志复制进度），并在Leader崩溃后正确地初始化这两个数组。</li><li>当Follower接收到日志时，需检查RPC中Leader认定的当前Follower的<code>prevLogIndex</code>和<code>prevLogTerm</code>，判断日志是否存在冲突，若存在冲突，需由Leader从冲突点开始强制覆盖Follower的日志。</li><li>新的Leader的日志需确保包含了所有已提交的日志条目。Follower可能在Leader提交日志期间进入不可用状态，从而导致被选为新Leader的Follower可能覆盖已提交的日志条目。为避免这种情况，选举时需加入Leader限制机制，即Follower只给任期和日志更新的Candidate投票，具体规则如下：<ul><li>如果任期号不同，任期号较大的Candidate更新；</li><li>如果任期号相同，日志索引值较大（即日志更长）的Candidate更新。</li></ul></li></ul></blockquote><p>核心的<code>AppendEntries</code> RPC实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span><span class=lnt>42
</span><span class=lnt>43
</span><span class=lnt>44
</span><span class=lnt>45
</span><span class=lnt>46
</span><span class=lnt>47
</span><span class=lnt>48
</span><span class=lnt>49
</span><span class=lnt>50
</span><span class=lnt>51
</span><span class=lnt>52
</span><span class=lnt>53
</span><span class=lnt>54
</span><span class=lnt>55
</span><span class=lnt>56
</span><span class=lnt>57
</span><span class=lnt>58
</span><span class=lnt>59
</span><span class=lnt>60
</span><span class=lnt>61
</span><span class=lnt>62
</span><span class=lnt>63
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>AppendEntries</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>AppendEntriesArgs</span><span class=p>,</span> <span class=nx>reply</span> <span class=o>*</span><span class=nx>AppendEntriesReply</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Your code here (3A, 3B).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node %v}&#39;s state is {state %v, term %v}} after processing AppendEntries,  AppendEntriesArgs %v and AppendEntriesReply %v &#34;</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>state</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=nx>reply</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Reply false if term &lt; currentTerm(§5.1)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&lt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Success</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// indicate the peer is the leader
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nf>ChangeState</span><span class=p>(</span><span class=nx>Follower</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>RandomElectionTimeout</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Reply false if log doesn’t contain an entry at prevLogIndex whose term matches prevLogTerm(§5.3)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>PrevLogIndex</span> <span class=p>&lt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getFirstLog</span><span class=p>().</span><span class=nx>Index</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Success</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// check the log is matched, if not, return the conflict index and term
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// if an existing entry conflicts with a new one (same index but different terms), delete the existing entry and all that follow it(§5.3)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=p>!</span><span class=nx>rf</span><span class=p>.</span><span class=nf>isLogMatched</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>PrevLogIndex</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>PrevLogTerm</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Success</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>		<span class=nx>lastLogIndex</span> <span class=o>:=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getLastLog</span><span class=p>().</span><span class=nx>Index</span>
</span></span><span class=line><span class=cl>		<span class=c1>// find the first index of the conflicting term
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>lastLogIndex</span> <span class=p>&lt;</span> <span class=nx>args</span><span class=p>.</span><span class=nx>PrevLogIndex</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// the last log index is smaller than the prevLogIndex, then the conflict index is the last log index
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>reply</span><span class=p>.</span><span class=nx>ConflictIndex</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>ConflictTerm</span> <span class=p>=</span> <span class=nx>lastLogIndex</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>firstLogIndex</span> <span class=o>:=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getFirstLog</span><span class=p>().</span><span class=nx>Index</span>
</span></span><span class=line><span class=cl>			<span class=c1>// find the first index of the conflicting term
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>index</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>PrevLogIndex</span>
</span></span><span class=line><span class=cl>			<span class=k>for</span> <span class=nx>index</span> <span class=o>&gt;=</span> <span class=nx>firstLogIndex</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>[</span><span class=nx>index</span><span class=o>-</span><span class=nx>firstLogIndex</span><span class=p>].</span><span class=nx>Term</span> <span class=o>==</span> <span class=nx>args</span><span class=p>.</span><span class=nx>PrevLogTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>index</span><span class=o>--</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=nx>reply</span><span class=p>.</span><span class=nx>ConflictIndex</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>ConflictTerm</span> <span class=p>=</span> <span class=nx>index</span><span class=o>+</span><span class=mi>1</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>PrevLogTerm</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// append any new entries not already in the log
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>firstLogIndex</span> <span class=o>:=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getFirstLog</span><span class=p>().</span><span class=nx>Index</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>index</span><span class=p>,</span> <span class=nx>entry</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Entries</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=c1>// find the junction of the existing log and the appended log.
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>if</span> <span class=nx>entry</span><span class=p>.</span><span class=nx>Index</span><span class=o>-</span><span class=nx>firstLogIndex</span> <span class=o>&gt;=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>)</span> <span class=o>||</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>[</span><span class=nx>entry</span><span class=p>.</span><span class=nx>Index</span><span class=o>-</span><span class=nx>firstLogIndex</span><span class=p>].</span><span class=nx>Term</span> <span class=o>!=</span> <span class=nx>entry</span><span class=p>.</span><span class=nx>Term</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span> <span class=p>=</span> <span class=nb>append</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>[:</span><span class=nx>entry</span><span class=p>.</span><span class=nx>Index</span><span class=o>-</span><span class=nx>firstLogIndex</span><span class=p>],</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Entries</span><span class=p>[</span><span class=nx>index</span><span class=p>:]</span><span class=o>...</span><span class=p>)</span>
</span></span><span class=line><span class=cl>			<span class=k>break</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// If leaderCommit &gt; commitIndex, set commitIndex = min(leaderCommit, index of last new entry) (paper)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>newCommitIndex</span> <span class=o>:=</span> <span class=nf>Min</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>LeaderCommit</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getLastLog</span><span class=p>().</span><span class=nx>Index</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>newCommitIndex</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>commitIndex</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>commitIndex</span> <span class=p>=</span> <span class=nx>newCommitIndex</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>applyCond</span><span class=p>.</span><span class=nf>Signal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Success</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>true</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>replicateOnceRound</code>用来调用<code>AppendEntries</code>RPC，并根据<code>reply</code>继续相应处理：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span><span class=lnt>39
</span><span class=lnt>40
</span><span class=lnt>41
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>replicateOnceRound</span><span class=p>(</span><span class=nx>peer</span> <span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RLock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>state</span> <span class=o>!=</span> <span class=nx>Leader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>prevLogIndex</span> <span class=o>:=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>nextIndex</span><span class=p>[</span><span class=nx>peer</span><span class=p>]</span> <span class=o>-</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>	<span class=nx>args</span> <span class=o>:=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>genAppendEntriesArgs</span><span class=p>(</span><span class=nx>prevLogIndex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>RUnlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>reply</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>AppendEntriesReply</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>sendAppendEntries</span><span class=p>(</span><span class=nx>peer</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=nx>reply</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=o>==</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>Leader</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=k>if</span> <span class=p>!</span><span class=nx>reply</span><span class=p>.</span><span class=nx>Success</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=k>if</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// indicate current server is not the leader
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>rf</span><span class=p>.</span><span class=nf>ChangeState</span><span class=p>(</span><span class=nx>Follower</span><span class=p>)</span>
</span></span><span class=line><span class=cl>					<span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=p>=</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span> <span class=o>==</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>					<span class=c1>// decrease nextIndex and retry
</span></span></span><span class=line><span class=cl><span class=c1></span>					<span class=nx>rf</span><span class=p>.</span><span class=nx>nextIndex</span><span class=p>[</span><span class=nx>peer</span><span class=p>]</span> <span class=p>=</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>ConflictIndex</span>
</span></span><span class=line><span class=cl>					<span class=k>if</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>ConflictTerm</span> <span class=o>!=</span> <span class=o>-</span><span class=mi>1</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>						<span class=nx>firstLogIndex</span> <span class=o>:=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getFirstLog</span><span class=p>().</span><span class=nx>Index</span>
</span></span><span class=line><span class=cl>						<span class=k>for</span> <span class=nx>index</span> <span class=o>:=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>PrevLogIndex</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=nx>index</span> <span class=o>&gt;=</span> <span class=nx>firstLogIndex</span><span class=p>;</span> <span class=nx>index</span><span class=o>--</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>							<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>[</span><span class=nx>index</span><span class=o>-</span><span class=nx>firstLogIndex</span><span class=p>].</span><span class=nx>Term</span> <span class=o>==</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>ConflictTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>								<span class=nx>rf</span><span class=p>.</span><span class=nx>nextIndex</span><span class=p>[</span><span class=nx>peer</span><span class=p>]</span> <span class=p>=</span> <span class=nx>index</span>
</span></span><span class=line><span class=cl>								<span class=k>break</span>
</span></span><span class=line><span class=cl>							<span class=p>}</span>
</span></span><span class=line><span class=cl>						<span class=p>}</span>
</span></span><span class=line><span class=cl>					<span class=p>}</span>
</span></span><span class=line><span class=cl>				<span class=p>}</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>rf</span><span class=p>.</span><span class=nx>matchIndex</span><span class=p>[</span><span class=nx>peer</span><span class=p>]</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>PrevLogIndex</span> <span class=o>+</span> <span class=nb>len</span><span class=p>(</span><span class=nx>args</span><span class=p>.</span><span class=nx>Entries</span><span class=p>)</span>
</span></span><span class=line><span class=cl>				<span class=nx>rf</span><span class=p>.</span><span class=nx>nextIndex</span><span class=p>[</span><span class=nx>peer</span><span class=p>]</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>matchIndex</span><span class=p>[</span><span class=nx>peer</span><span class=p>]</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=cl>				<span class=c1>// advance commitIndex if possible
</span></span></span><span class=line><span class=cl><span class=c1></span>				<span class=nx>rf</span><span class=p>.</span><span class=nf>advanceCommitIndexForLeader</span><span class=p>()</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>Leader应用已提交log的<code>advanceCommitIndexForLeader</code>函数实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>advanceCommitIndexForLeader</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>n</span> <span class=o>:=</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>matchIndex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>sortMatchIndex</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=kt>int</span><span class=p>,</span> <span class=nx>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nb>copy</span><span class=p>(</span><span class=nx>sortMatchIndex</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>matchIndex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>sort</span><span class=p>.</span><span class=nf>Ints</span><span class=p>(</span><span class=nx>sortMatchIndex</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=c1>// get the index of the log entry with the highest index that is known to be replicated on a majority of servers
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>newCommitIndex</span> <span class=o>:=</span> <span class=nx>sortMatchIndex</span><span class=p>[</span><span class=nx>n</span><span class=o>-</span><span class=p>(</span><span class=nx>n</span><span class=o>/</span><span class=mi>2</span><span class=o>+</span><span class=mi>1</span><span class=p>)]</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>newCommitIndex</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>commitIndex</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>isLogMatched</span><span class=p>(</span><span class=nx>newCommitIndex</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>commitIndex</span> <span class=p>=</span> <span class=nx>newCommitIndex</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>applyCond</span><span class=p>.</span><span class=nf>Signal</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>每个peer应用已提交的goroutine <code>applier</code>实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>applier</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>for</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>killed</span><span class=p>()</span> <span class=o>==</span> <span class=kc>false</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=c1>// check the commitIndex is advanced
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>commitIndex</span> <span class=o>&lt;=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>lastApplied</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=c1>// need to wait for the commitIndex to be advanced
</span></span></span><span class=line><span class=cl><span class=c1></span>			<span class=nx>rf</span><span class=p>.</span><span class=nx>applyCond</span><span class=p>.</span><span class=nf>Wait</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>		<span class=c1>// apply log entries to state machine
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>firstLogIndex</span><span class=p>,</span> <span class=nx>commitIndex</span><span class=p>,</span> <span class=nx>lastApplied</span> <span class=o>:=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getFirstLog</span><span class=p>().</span><span class=nx>Index</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>commitIndex</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>lastApplied</span>
</span></span><span class=line><span class=cl>		<span class=nx>entries</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>LogEntry</span><span class=p>,</span> <span class=nx>commitIndex</span><span class=o>-</span><span class=nx>lastApplied</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=nb>copy</span><span class=p>(</span><span class=nx>entries</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>[</span><span class=nx>lastApplied</span><span class=o>-</span><span class=nx>firstLogIndex</span><span class=o>+</span><span class=mi>1</span><span class=p>:</span><span class=nx>commitIndex</span><span class=o>-</span><span class=nx>firstLogIndex</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=c1>// send the apply message to applyCh for service/State Machine Replica
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>for</span> <span class=nx>_</span><span class=p>,</span> <span class=nx>entry</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>entries</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>rf</span><span class=p>.</span><span class=nx>applyCh</span> <span class=o>&lt;-</span> <span class=nx>ApplyMsg</span><span class=p>{</span>
</span></span><span class=line><span class=cl>				<span class=nx>CommandValid</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>Command</span><span class=p>:</span>      <span class=nx>entry</span><span class=p>.</span><span class=nx>Command</span><span class=p>,</span>
</span></span><span class=line><span class=cl>				<span class=nx>CommandIndex</span><span class=p>:</span> <span class=nx>entry</span><span class=p>.</span><span class=nx>Index</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>		<span class=c1>// use commitIndex rather than rf.commitIndex because rf.commitIndex may change during the Unlock() and Lock()
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=nx>rf</span><span class=p>.</span><span class=nx>lastApplied</span> <span class=p>=</span> <span class=nx>commitIndex</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h3 id=lab3c持久化 class=heading-element><span>2.4 lab3C：持久化</span>
<a href=#lab3c%e6%8c%81%e4%b9%85%e5%8c%96 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>如果基于 Raft 的服务器重新启动，它应该从中断处恢复服务。这要求 Raft 保持在重启后仍然存在的持久状态。论文的图 2 提到了哪种状态应该是持久的，即<code>logs</code>、<code>currentTerm</code>和<code>votedFor</code>。在Lab3C中，我们的任务便是实现<code>persist()</code>和<code>readPersist()</code>这两个核心函数，前者负责保存Raft的状态，后者则是在Raft启动时恢复之前保存的数据。</p><p><code>readPersist</code>函数实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>readPersist</span><span class=p>(</span><span class=nx>data</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>data</span> <span class=o>==</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nb>len</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span> <span class=p>&lt;</span> <span class=mi>1</span> <span class=p>{</span> <span class=c1>// bootstrap without any state?
</span></span></span><span class=line><span class=cl><span class=c1></span>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>r</span> <span class=o>:=</span> <span class=nx>bytes</span><span class=p>.</span><span class=nf>NewBuffer</span><span class=p>(</span><span class=nx>data</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>d</span> <span class=o>:=</span> <span class=nx>labgob</span><span class=p>.</span><span class=nf>NewDecoder</span><span class=p>(</span><span class=nx>r</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>votedFor</span> <span class=kt>int</span>
</span></span><span class=line><span class=cl>	<span class=kd>var</span> <span class=nx>logs</span> <span class=p>[]</span><span class=nx>LogEntry</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>d</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>currentTerm</span><span class=p>)</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>d</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>votedFor</span><span class=p>)</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=o>||</span> <span class=nx>d</span><span class=p>.</span><span class=nf>Decode</span><span class=p>(</span><span class=o>&amp;</span><span class=nx>logs</span><span class=p>)</span> <span class=o>!=</span> <span class=kc>nil</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node %v} fails to decode persisted state&#34;</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span> <span class=p>=</span> <span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>votedFor</span><span class=p>,</span> <span class=nx>logs</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>lastApplied</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>commitIndex</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getFirstLog</span><span class=p>().</span><span class=nx>Index</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getFirstLog</span><span class=p>().</span><span class=nx>Index</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>persist</code>函数实现：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>encodeState</span><span class=p>()</span> <span class=p>[]</span><span class=kt>byte</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>w</span> <span class=o>:=</span> <span class=nb>new</span><span class=p>(</span><span class=nx>bytes</span><span class=p>.</span><span class=nx>Buffer</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>e</span> <span class=o>:=</span> <span class=nx>labgob</span><span class=p>.</span><span class=nf>NewEncoder</span><span class=p>(</span><span class=nx>w</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>e</span><span class=p>.</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>e</span><span class=p>.</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>e</span><span class=p>.</span><span class=nf>Encode</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>w</span><span class=p>.</span><span class=nf>Bytes</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>persist</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>persister</span><span class=p>.</span><span class=nf>SaveStateAndSnapshot</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nf>encodeState</span><span class=p>(),</span> <span class=kc>nil</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>实现好后，我们只需要在入口处<code>Make</code>调用<code>readPersist</code>即可，关键需要在什么时候保存状态呢？其实很简单，只需要对我们需要持久化的三个字段修改的时候就进行<code>persist</code>操作。即<code>persist()</code>操作应当在以下几种情况下被触发：</p><ul><li><strong>日志条目更新</strong>：当有新的日志条目被添加到<code>logs</code>中，或是已有条目被删除或替换时。</li><li><strong>任期变更</strong>：当<code>currentTerm</code>发生变化，比如在选举期间或接收到更高任期的领导者信息时。</li><li><strong>投票行为</strong>：当<code>votedFor</code>字段被更新，意味着节点投出了新的一票或取消了之前的投票。</li></ul><h3 id=lab3d日志压缩 class=heading-element><span>2.5 lab3D：日志压缩</span>
<a href=#lab3d%e6%97%a5%e5%bf%97%e5%8e%8b%e7%bc%a9 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h3><p>按照目前的情况，重新启动的服务器会重放完整的 Raft 日志以恢复其状态。然而，对于一个长期运行的服务来说，永远记录完整的 Raft 日志是不切实际的。需要使用快照服务配合，此时Raft会丢弃快照之前的日志条目。lab3D就是需要我们实现日志压缩，具体来说是核心是<code>Snapshot</code>（快照保存函数）以及<code>InstallSnapshot</code>RPC，快照压缩的流程：</p><ol><li>每个peer都会通过<code>Snapshot</code>捕获当前系统状态的一个快照。这通常包括但不限于状态机的当前状态、任何必要的元数据、以及快照生成时的任期信息。</li><li>当Leader认为有必要向Follower发送快照时，它将发起<code>InstallSnapshot</code>RPC调用。这通常发生在Follower的日志状态与Leader严重脱节时，例如日志冲突无法通过常规的<code>AppendEntries</code>RPC解决。</li><li>Follower接收到快照后，会验证其完整性和一致性，然后应用快照以替换其当前状态和日志。这包括清除快照点之前的所有日志条目，并将状态机恢复到快照所表示的状态。</li><li>Follower在成功应用快照后，应通过RPC回复向Leader确认，表明快照已被正确安装。Leader据此更新其<code>matchIndex</code>和<code>nextIndex</code>数组，以反映Follower的最新状态。</li></ol><p><a class=lightgallery href="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811144255744.png?size=large" data-thumbnail="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811144255744.png?size=small" data-sub-html="<h2>image-20240811144255744</h2>"><img loading=lazy src=https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811144255744.png alt=image-20240811144255744 srcset="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811144255744.png?size=small, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811144255744.png?size=medium 1.5x, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811144255744.png?size=large 2x" data-title=image-20240811144255744 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><blockquote><p>在lab3D实现过程中，需要注意以下几点：</p><ol><li>在更新 <code>lastApplied</code> 时，必须采用前一时刻的 <code>commitIndex</code> 值，而非实时的 <code>rf.commitIndex</code>。这是因为，在执行 <code>push applyCh</code> 过程中，<code>rf.commitIndex</code> 可能因其他操作而动态变化，使用其历史值可以保证 <code>lastApplied</code> 更新的准确性。</li><li>需要注意使用<code>CondInstallSnapshot</code>来验证快照的有效性。</li><li>在修剪log的时候注意留一个dummy log</li><li>使用 <code>Max(rf.lastApplied, commitIndex)</code> 而不是直接使用 <code>commitIndex</code> 来避免并发 InstallSnapshot RPC 导致 <code>lastApplied</code> 回滚</li></ol></blockquote><p><code>InstallSnapshot</code> RPC实现如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>InstallSnapshot</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>InstallSnapshotArgs</span><span class=p>,</span> <span class=nx>reply</span> <span class=o>*</span><span class=nx>InstallSnapshotReply</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// reply immediately if term &lt; currentTerm
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&lt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=p>=</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=o>-</span><span class=mi>1</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nf>persist</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nf>ChangeState</span><span class=p>(</span><span class=nx>Follower</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>RandomElectionTimeout</span><span class=p>())</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// check the snapshot is more up-to-date than the current log
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>LastIncludedIndex</span> <span class=o>&lt;=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>commitIndex</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=k>go</span> <span class=kd>func</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>applyCh</span> <span class=o>&lt;-</span> <span class=nx>ApplyMsg</span><span class=p>{</span>
</span></span><span class=line><span class=cl>			<span class=nx>SnapshotValid</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>Snapshot</span><span class=p>:</span>      <span class=nx>args</span><span class=p>.</span><span class=nx>Data</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>SnapshotTerm</span><span class=p>:</span>  <span class=nx>args</span><span class=p>.</span><span class=nx>LastIncludedTerm</span><span class=p>,</span>
</span></span><span class=line><span class=cl>			<span class=nx>SnapshotIndex</span><span class=p>:</span> <span class=nx>args</span><span class=p>.</span><span class=nx>LastIncludedIndex</span><span class=p>,</span>
</span></span><span class=line><span class=cl>		<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=p>}()</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p><code>Snapshot</code>函数实现如下，它接收客户端创建的快照。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>Snapshot</span><span class=p>(</span><span class=nx>index</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>snapshot</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=nx>snapshotIndex</span> <span class=o>:=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getFirstLog</span><span class=p>().</span><span class=nx>Index</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nx>index</span> <span class=o>&lt;=</span> <span class=nx>snapshotIndex</span> <span class=o>||</span> <span class=nx>index</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getLastLog</span><span class=p>().</span><span class=nx>Index</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nf>DPrintf</span><span class=p>(</span><span class=s>&#34;{Node %v} rejects replacing log with snapshotIndex %v as current snapshotIndex %v is larger in term %v&#34;</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>index</span><span class=p>,</span> <span class=nx>snapshotIndex</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// remove log entries up to index
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>[</span><span class=nx>index</span><span class=o>-</span><span class=nx>snapshotIndex</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Command</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>persister</span><span class=p>.</span><span class=nf>SaveStateAndSnapshot</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nf>encodeState</span><span class=p>(),</span> <span class=nx>snapshot</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><p>还有一个<code>CondInstallSnapshot</code>，用来peer判断leader发过来的快照是否满足条件，如果满足，则安装快照。这个需要修改到<code>config.go</code>文件中。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>CondInstallSnapshot</span><span class=p>(</span><span class=nx>lastIncludedTerm</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>lastIncludedIndex</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>snapshot</span> <span class=p>[]</span><span class=kt>byte</span><span class=p>)</span> <span class=kt>bool</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
</span></span><span class=line><span class=cl>	<span class=c1>// outdated snapshot
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>lastIncludedIndex</span> <span class=o>&lt;=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>commitIndex</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=kc>false</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=c1>// need dummy entry at index 0
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=k>if</span> <span class=nx>lastIncludedIndex</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getLastLog</span><span class=p>().</span><span class=nx>Index</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span> <span class=p>=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>LogEntry</span><span class=p>,</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span> <span class=k>else</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>[</span><span class=nx>lastIncludedIndex</span><span class=o>-</span><span class=nx>rf</span><span class=p>.</span><span class=nf>getFirstLog</span><span class=p>().</span><span class=nx>Index</span><span class=p>:]</span>
</span></span><span class=line><span class=cl>		<span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Command</span> <span class=p>=</span> <span class=kc>nil</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>logs</span><span class=p>[</span><span class=mi>0</span><span class=p>].</span><span class=nx>Index</span> <span class=p>=</span> <span class=nx>lastIncludedTerm</span><span class=p>,</span> <span class=nx>lastIncludedIndex</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>commitIndex</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>lastApplied</span> <span class=p>=</span> <span class=nx>lastIncludedIndex</span><span class=p>,</span> <span class=nx>lastIncludedIndex</span>
</span></span><span class=line><span class=cl>	<span class=nx>rf</span><span class=p>.</span><span class=nx>persister</span><span class=p>.</span><span class=nf>SaveStateAndSnapshot</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nf>encodeState</span><span class=p>(),</span> <span class=nx>snapshot</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div><h2 id=压测脚本 class=heading-element><span>3 压测脚本</span>
<a href=#%e5%8e%8b%e6%b5%8b%e8%84%9a%e6%9c%ac class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>我自己实现了一个压测脚本：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># check the number of arguments</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$#</span><span class=s2>&#34;</span> -ne <span class=m>2</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;Usage: </span><span class=nv>$0</span><span class=s2> &lt;test_type&gt; &lt;iterations&gt;&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;test_type must be one of 3A, 3B, 3C, 3D&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>test_type</span><span class=o>=</span><span class=nv>$1</span>
</span></span><span class=line><span class=cl><span class=nv>iterations</span><span class=o>=</span><span class=nv>$2</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># check the test_type</span>
</span></span><span class=line><span class=cl><span class=k>if</span> <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$test_type</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;3A&#34;</span> <span class=o>&amp;&amp;</span> <span class=s2>&#34;</span><span class=nv>$test_type</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;3B&#34;</span> <span class=o>&amp;&amp;</span> <span class=s2>&#34;</span><span class=nv>$test_type</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;3C&#34;</span> <span class=o>&amp;&amp;</span> <span class=s2>&#34;</span><span class=nv>$test_type</span><span class=s2>&#34;</span> !<span class=o>=</span> <span class=s2>&#34;3D&#34;</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;Invalid test_type: </span><span class=nv>$test_type</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;test_type must be one of 3A, 3B, 3C, 3D&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># check the iterations is a positive integer</span>
</span></span><span class=line><span class=cl><span class=k>if</span> ! <span class=o>[[</span> <span class=s2>&#34;</span><span class=nv>$iterations</span><span class=s2>&#34;</span> <span class=o>=</span>~ ^<span class=o>[</span>0-9<span class=o>]</span>+$ <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;Invalid iterations: </span><span class=nv>$iterations</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;iterations must be a positive integer&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nb>exit</span> <span class=m>1</span>
</span></span><span class=line><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s2>&#34;go test -run </span><span class=nv>$test_type</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl><span class=k>for</span> <span class=o>((</span><span class=nv>i</span><span class=o>=</span>1<span class=p>;</span> i&lt;<span class=o>=</span>iterations<span class=p>;</span> i++<span class=o>))</span>
</span></span><span class=line><span class=cl><span class=k>do</span>
</span></span><span class=line><span class=cl>  <span class=nb>echo</span> <span class=s2>&#34;Running test iteration </span><span class=nv>$i</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=nv>output</span><span class=o>=</span><span class=k>$(</span>go <span class=nb>test</span> -run <span class=nv>$test_type</span> 2&gt;<span class=p>&amp;</span>1<span class=k>)</span> <span class=c1>#&gt;&amp;1 redirects stderr to stdout</span>
</span></span><span class=line><span class=cl>  <span class=k>if</span> <span class=o>[[</span> <span class=nv>$?</span> -ne <span class=m>0</span> <span class=o>]]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;Error in iteration </span><span class=nv>$i</span><span class=s2>:&#34;</span>
</span></span><span class=line><span class=cl>    <span class=nb>echo</span> <span class=s2>&#34;</span><span class=nv>$output</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=cl>  <span class=k>fi</span>
</span></span><span class=line><span class=cl><span class=k>done</span></span></span></code></pre></td></tr></table></div></div><p>网上也提供了一个<a href=https://gist.github.com/JJGO/0d73540ef7cc2f066cb535156b7cbdab target=_blank rel="external nofollow noopener noreferrer">测试脚本<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>，功能更为强大。压测结果如下所示：</p><p><a class=lightgallery href="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811175403947.png?size=large" data-thumbnail="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811175403947.png?size=small" data-sub-html="<h2>image-20240811175403947</h2>"><img loading=lazy src=https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811175403947.png alt=image-20240811175403947 srcset="https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811175403947.png?size=small, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811175403947.png?size=medium 1.5x, https://raw.githubusercontent.com/HeZephyr/NewPicGoLibrary/main/img/image-20240811175403947.png?size=large 2x" data-title=image-20240811175403947 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><h2 id=优化 class=heading-element><span>4 优化</span>
<a href=#%e4%bc%98%e5%8c%96 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><ol><li><p>如果我们使用的空间少于数组的一半，我们就替换该数组。这个数字是相当任意的，选择它是为了平衡内存使用与分配数量，这个数字可能还可以改进。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=line><span class=cl><span class=kd>func</span> <span class=nf>shrinkEntries</span><span class=p>(</span><span class=nx>entries</span> <span class=p>[]</span><span class=nx>LogEntry</span><span class=p>)</span> <span class=p>[]</span><span class=nx>LogEntry</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kd>const</span> <span class=nx>lenMultiple</span> <span class=p>=</span> <span class=mi>2</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=nb>cap</span><span class=p>(</span><span class=nx>entries</span><span class=p>)</span> <span class=p>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>entries</span><span class=p>)</span><span class=o>*</span><span class=nx>lenMultiple</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=nx>newEntries</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>([]</span><span class=nx>LogEntry</span><span class=p>,</span> <span class=nb>len</span><span class=p>(</span><span class=nx>entries</span><span class=p>))</span>
</span></span><span class=line><span class=cl>		<span class=nb>copy</span><span class=p>(</span><span class=nx>newEntries</span><span class=p>,</span> <span class=nx>entries</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=k>return</span> <span class=nx>newEntries</span>
</span></span><span class=line><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=nx>entries</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></td></tr></table></div></div></li><li><p>因为日志的索引是单调递增的，而term则是非递减的。所以这里应该可以使用二分优化。</p></li></ol></div><hr class=awesome-hr><h2 id=see-also>相关内容</h2><ul><li><a href=/posts/06.mit-6.58406.824-lab2-kv-server/ title="【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现">【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现</a></li><li><a href=/posts/08.%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0zookeeper-wait-free-coordination-for-internet-scale-systems/ title="【论文阅读笔记】ZooKeeper: Wait-Free Coordination for Internet-Scale Systems">【论文阅读笔记】ZooKeeper: Wait-Free Coordination for Internet-Scale Systems</a></li><li><a href=/posts/07.raft/ title="【MIT 6.5840(6.824)学习笔记】Raft">【MIT 6.5840(6.824)学习笔记】Raft</a></li><li><a href=/posts/03.%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0in-search-of-an-understandable-consensus-algorithm-extended-version/ title="【论文阅读笔记】In Search of an Understandable Consensus Algorithm (Extended Version)">【论文阅读笔记】In Search of an Understandable Consensus Algorithm (Extended Version)</a></li><li><a href=/posts/04.gfs/ title="【MIT 6.5840(6.824)学习笔记】GFS">【MIT 6.5840(6.824)学习笔记】GFS</a></li></ul><div class=post-reward><div class=comment>Buy me a coffee~</div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=fixed><div><img loading=lazy src=/images/alipay.png alt="HeZephyr 支付宝" data-title="HeZephyr 支付宝" style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span data-animation>支付宝</span></div><div><img loading=lazy src=/images/wechatpay.jpg alt="HeZephyr 微信" data-title="HeZephyr 微信" style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span data-animation>微信</span></div></div></div><div class=collection-card><div class="collection-title text-secondary">收录于 <a href=/collections/mit-6.5840/><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> <span>合集・MIT 6.5840</span></span></a> 10</div><div class=collection-nav><a href=/posts/07.raft/ class=collection-nav-item rel=prev title="【MIT 6.5840(6.824)学习笔记】Raft"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i><span>【MIT 6.5840(6.824)学习笔记】Raft</span>
</a><a href=/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/ class=collection-nav-item rel=next title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现"><span>【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现</span><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=collection-card><div class="collection-title text-secondary">收录于 <a href=/collections/%E5%8A%A8%E6%89%8B%E5%AE%9E%E8%B7%B5/><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> <span>合集・动手实践</span></span></a> 5</div><div class=collection-nav><a href=/posts/06.mit-6.58406.824-lab2-kv-server/ class=collection-nav-item rel=prev title="【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i><span>【MIT 6.5840(6.824) 】Lab2:Key/Value Server 设计实现</span>
</a><a href=/posts/09.mit-6.58406.824-lab4-fault-tolerant-kvservice/ class=collection-nav-item rel=next title="【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现"><span>【MIT 6.5840(6.824)】 Lab 4:Fault-Tolerant KVService 设计实现</span><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2024-10-15 18:55:47">更新于 2024-10-15&nbsp;
<a class=git-hash href=https://github.com/HeZephyr/HeZephyr.github.io/commit/0d120d772730b99c7326e3566f86718e5eb5dfed rel="external nofollow noopener noreferrer" target=_blank title="commit by zfhe(2825841950@qq.com) 0d120d772730b99c7326e3566f86718e5eb5dfed: :pencil: Docs: Zephyr's Note update 2024-10-15 二 18:55:47"><i class="fa-solid fa-hashtag fa-fw" aria-hidden=true></i>0d120d7</a></span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/08.mit-6.58406.824-lab3-raft/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span><span><a href="https://github.com/HeZephyr/HeZephyr.github.io/blob/docs/content/posts/_develop/_system/distributed_system/08.MIT%206.5840%286.824%29%20Lab3%20Raft.md?plain=1" title=查看源码 target=_blank rel="external nofollow noopener noreferrer" class=link-to-source>查看源码</a></span><span><a href=https://github.com/HeZephyr/HeZephyr.github.io/edit/docs/content/posts/_develop/_system/distributed_system/08.MIT%206.5840%286.824%29%20Lab3%20Raft.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span><span><a href="https://github.com/HeZephyr/HeZephyr.github.io/issues/new?title=[BUG]%20%E3%80%90MIT+6.5840%286.824%29+%E3%80%91Lab3%3ARaft+%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7c%E3%80%90MIT+6.5840%286.824%29+%E3%80%91Lab3%3ARaft+%E8%AE%BE%E8%AE%A1%E5%AE%9E%E7%8E%B0%7c%0A%7cURL%7chttps://hezephyr.github.io/posts/08.mit-6.58406.824-lab3-raft/%7c%0A%7cFilename%7chttps://github.com/HeZephyr/HeZephyr.github.io/blob/docs/content/posts/_develop/_system/distributed_system/08.MIT%206.5840%286.824%29%20Lab3%20Raft.md?plain=1%7c" title=报告问题 target=_blank rel="external nofollow noopener noreferrer" class=link-to-report>报告问题</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=twitter data-url=https://hezephyr.github.io/posts/08.mit-6.58406.824-lab3-raft/ data-title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现" data-hashtags=分布式系统><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://hezephyr.github.io/posts/08.mit-6.58406.824-lab3-raft/ data-hashtag=分布式系统><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://hezephyr.github.io/posts/08.mit-6.58406.824-lab3-raft/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://hezephyr.github.io/posts/08.mit-6.58406.824-lab3-raft/ data-title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://hezephyr.github.io/posts/08.mit-6.58406.824-lab3-raft/ data-title="【MIT 6.5840(6.824) 】Lab3:Raft 设计实现"><i data-svg-src=https://unpkg.com/simple-icons@9.19.0/icons/baidu.svg aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/ class=post-tag title="标签 - 分布式系统">分布式系统</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/09.%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0grove/ class=post-nav-item rel=prev title="【论文阅读笔记】Grove: A Separation-Logic Library for Verifying Distributed Systems (Extended Version)"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>【论文阅读笔记】Grove: A Separation-Logic Library for Verifying Distributed Systems (Extended Version)</a>
<a href=/posts/08.%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0zookeeper-wait-free-coordination-for-internet-scale-systems/ class=post-nav-item rel=next title="【论文阅读笔记】ZooKeeper: Wait-Free Coordination for Internet-Scale Systems">【论文阅读笔记】ZooKeeper: Wait-Free Coordination for Internet-Scale Systems<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=HeZephyr/HeZephyr.github.io data-repo-id=R_kgDOMb2HgQ data-category=General data-category-id=DIC_kwDOMb2Hgc4ChPAb data-mapping=title data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered order-1">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.136.5"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.9-RC"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright order-2" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2020 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/HeZephyr target=_blank rel="external nofollow noopener noreferrer">HeZephyr</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div><div class="footer-line statistics"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="ms-1 d-none">博客已运行</span><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-first"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/HeZephyr title="View on GitHub" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:#8581dd;--bg-progress-dark:#fff></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=https://unpkg.com/lightgallery@2.7.2/css/lightgallery-bundle.min.css><link rel=preload href=https://unpkg.com/katex@0.16.10/dist/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/katex@0.16.10/dist/katex.min.css></noscript><link rel=stylesheet href=https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.css><link rel=stylesheet href=https://unpkg.com/pace-js@1.2.4/themes/blue/pace-theme-minimal.css><script src=https://unpkg.com/autocomplete.js@0.38.1/dist/autocomplete.min.js defer></script><script src=https://unpkg.com/algoliasearch@4.20.0/dist/algoliasearch-lite.umd.js defer></script><script src=https://unpkg.com/instant.page@5.2.0/instantpage.js async defer type=module></script><script src=https://unpkg.com/lightgallery@2.7.2/lightgallery.min.js defer></script><script src=https://unpkg.com/lightgallery@2.7.2/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=https://unpkg.com/lightgallery@2.7.2/plugins/zoom/lg-zoom.min.js defer></script><script src=https://unpkg.com/sharer.js@0.5.1/sharer.min.js async defer></script><script src=https://unpkg.com/katex@0.16.10/dist/katex.min.js defer></script><script src=https://unpkg.com/katex@0.16.10/dist/contrib/auto-render.min.js defer></script><script src=https://unpkg.com/katex@0.16.10/dist/contrib/copy-tex.min.js defer></script><script src=https://unpkg.com/katex@0.16.10/dist/contrib/mhchem.min.js defer></script><script src=https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.js defer></script><script src=https://unpkg.com/pangu@4.0.7/dist/browser/pangu.min.js defer></script><script src=https://unpkg.com/cell-watermark@1.0.3/src/watermark.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=https://unpkg.com/pace-js@1.2.4/pace.min.js async defer></script><script src=/js/flyfish.js defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:50},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark_dimmed",lightTheme:"light",origin:"https://giscus.app"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!0,left:"$$",right:"$$"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"},{display:!1,left:"$",right:"$"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{algoliaAppID:"LKM6MKQ6NB",algoliaIndex:"index",algoliaSearchKey:"c9bb91e3a1318f3c9efae98daa87bca5",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},siteTime:"2020-06-10T15:42:01+08:00",version:"v0.3.9-RC",watermark:{colspacing:30,content:'<img style="height: 0.85rem;" src="/logo.png" alt="logo" /> 贺志飞',enable:!0,fontfamily:"LiuJianMaoCao-Regular, 钟齐流江毛草",fontsize:1.1,height:20,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script></body></html>