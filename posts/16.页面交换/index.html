<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-CN><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>页面交换 | ZephyrHe</title><meta name=author content="HeZephyr">
<meta name=author-link content="https://github.com/HeZephyr"><meta name=description content="到目前为止，我们假设地址空间小得不切实际，并且适合物理内存。事实上，我们一直假设每个正在运行的进程的每个地址空间都适合内存。现在，我们将放宽这些重大假设，并假设我们希望支持许多并发运行的大型地址空间。 为此，我们需要在内存层次结构中增加一个级别。到目前为止，我们假设所有页面都驻留在物理内存中。然而，为"><meta name=keywords content='OS'><meta itemprop=name content="页面交换"><meta itemprop=description content="到目前为止，我们假设地址空间小得不切实际，并且适合物理内存。事实上，我们一直假设每个正在运行的进程的每个地址空间都适合内存。现在，我们将放宽这些重大假设，并假设我们希望支持许多并发运行的大型地址空间。 为此，我们需要在内存层次结构中增加一个级别。到目前为止，我们假设所有页面都驻留在物理内存中。然而，为"><meta itemprop=datePublished content="2024-04-25T22:40:12+00:00"><meta itemprop=dateModified content="2024-07-29T12:45:24+00:00"><meta itemprop=wordCount content="4368"><meta itemprop=image content="https://hezephyr.github.io/images/apple-devices-preview.webp"><meta itemprop=keywords content="OS"><meta property="og:url" content="https://hezephyr.github.io/posts/16.%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2/"><meta property="og:site_name" content="ZephyrHe"><meta property="og:title" content="页面交换"><meta property="og:description" content="到目前为止，我们假设地址空间小得不切实际，并且适合物理内存。事实上，我们一直假设每个正在运行的进程的每个地址空间都适合内存。现在，我们将放宽这些重大假设，并假设我们希望支持许多并发运行的大型地址空间。 为此，我们需要在内存层次结构中增加一个级别。到目前为止，我们假设所有页面都驻留在物理内存中。然而，为"><meta property="og:locale" content="zh_CN"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-04-25T22:40:12+00:00"><meta property="article:modified_time" content="2024-07-29T12:45:24+00:00"><meta property="article:tag" content="OS"><meta property="og:image" content="https://hezephyr.github.io/images/apple-devices-preview.webp"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://hezephyr.github.io/images/apple-devices-preview.webp"><meta name=twitter:title content="页面交换"><meta name=twitter:description content="到目前为止，我们假设地址空间小得不切实际，并且适合物理内存。事实上，我们一直假设每个正在运行的进程的每个地址空间都适合内存。现在，我们将放宽这些重大假设，并假设我们希望支持许多并发运行的大型地址空间。 为此，我们需要在内存层次结构中增加一个级别。到目前为止，我们假设所有页面都驻留在物理内存中。然而，为"><meta name=application-name content="Zephyr's Blog"><meta name=apple-mobile-web-app-title content="Zephyr's Blog"><meta name=theme-color data-light=#ffffff data-dark=#252627 content="#ffffff"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=manifest href=/site.webmanifest><link rel=canonical href=https://hezephyr.github.io/posts/16.%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2/><link rel=prev href=https://hezephyr.github.io/posts/15.%E9%AB%98%E7%BA%A7%E9%A1%B5%E8%A1%A8/><link rel=next href=https://hezephyr.github.io/posts/17.%E4%BA%A4%E6%8D%A2%E7%AD%96%E7%95%A5/><link rel=stylesheet href=/css/style.min.css><link rel=preload href=https://unpkg.com/@fortawesome/fontawesome-free@6.4.2/css/all.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/@fortawesome/fontawesome-free@6.4.2/css/all.min.css></noscript><link rel=preload href=https://unpkg.com/animate.css@4.1.1/animate.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/animate.css@4.1.1/animate.min.css></noscript><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"页面交换","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/hezephyr.github.io\/posts\/16.%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2\/"},"image":[{"@type":"ImageObject","url":"https:\/\/hezephyr.github.io\/images\/apple-devices-preview.webp","width":2880,"height":1508}],"genre":"posts","keywords":"OS","wordcount":4368,"url":"https:\/\/hezephyr.github.io\/posts\/16.%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2\/","datePublished":"2024-04-25T22:40:12+00:00","dateModified":"2024-07-29T12:45:24+00:00","license":"本站内容采用 CC BY-NC-SA 4.0 国际许可协议。","publisher":{"@type":"Organization","name":"Lruihao","logo":"https:\/\/hezephyr.github.io\/images\/avatar.jpg"},"author":{"@type":"Person","name":"HeZephyr"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=right><div class=header-title><a href=/ title=ZephyrHe><img loading=lazy src=/images/logo.png alt=ZephyrHe data-title=ZephyrHe width=26 height=26 class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>HeZephyr</span></a><span class=header-subtitle>贺志飞的博客</span></div><nav><ul class=menu><li class="menu-item has-children"><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a><i class="dropdown-icon fa-solid fa-chevron-down" aria-hidden=true></i><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users-viewfinder fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id=search-desktop><input type=text placeholder=搜索文章标题或内容…… id=search-input-desktop>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-desktop title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-desktop title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-desktop><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=ZephyrHe><img loading=lazy src=/images/logo.png alt=ZephyrHe data-title=ZephyrHe width=26 height=26 class=logo style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>HeZephyr</span></a><span class=header-subtitle>贺志飞的博客</span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=search-wrapper><div class="search mobile" id=search-mobile><input type=text placeholder=搜索文章标题或内容…… id=search-input-mobile>
<a href=javascript:void(0); class="search-button search-toggle" id=search-toggle-mobile title=搜索><i class="fa-solid fa-search fa-fw" aria-hidden=true></i>
</a><a href=javascript:void(0); class="search-button search-clear" id=search-clear-mobile title=清空><i class="fa-solid fa-times-circle fa-fw" aria-hidden=true></i>
</a><span class="search-button search-loading" id=search-loading-mobile><i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden=true></i></span></div><a href=javascript:void(0); class=search-cancel id=search-cancel-mobile>取消</a></li><li class=menu-item><span class=nested-item><a class=menu-link href=/archives/><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden=true></i> 归档</a>
<i class="dropdown-icon fa-solid fa-chevron-right" aria-hidden=true></i></span><ul class=sub-menu><li class=menu-item><a class=menu-link href=/categories/><i class="fa-solid fa-folder-tree fa-fw fa-sm" aria-hidden=true></i> 分类</a></li><li class=menu-item><a class=menu-link href=/collections/><i class="fa-solid fa-layer-group fa-fw fa-sm" aria-hidden=true></i> 合集</a></li><li class=menu-item><a class=menu-link href=/tags/><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden=true></i> 标签</a></li></ul></li><li class=menu-item><a class=menu-link href=/friends/ title=友情链接><i class="fa-solid fa-users-viewfinder fa-fw fa-sm" aria-hidden=true></i> 友链</a></li><li class=menu-item><a class=menu-link href=/guestbook/><i class="fa-solid fa-comments fa-fw fa-sm" aria-hidden=true></i> 留言</a></li><li class=menu-item><a class=menu-link href=/about/><i class="fa-solid fa-signature fa-fw fa-sm" aria-hidden=true></i> 关于</a></li><li class="menu-item text-center"><a class=menu-link href=https://github.com/HeZephyr/HeZephyr.github.io title=GitHub rel="noopener noreferrer" target=_blank><i class='fa-brands fa-github fa-fw' aria-hidden=true></i></a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><div class="search-dropdown desktop"><div id=search-dropdown-desktop></div></div><div class="search-dropdown mobile"><div id=search-dropdown-mobile></div></div><nav aria-label=breadcrumb class="breadcrumb-container sticky"><ol class=breadcrumb><li class=breadcrumb-item><a href=/posts/ title=Posts>文章</a></li><li class="breadcrumb-item active" aria-current=page>页面交换</li></ol></nav><main class=container><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label=合集><div class="details collection-details open"><div class="details-summary collection-summary"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i>
<span class=collection-name data-collections=合集>OSTEP</span>
<span class=collection-count>39</span><i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden=true></i></div><div class="details-content collection-content"><nav><ul class=collection-list><li class=collection-item><a href=/posts/01.%E8%BF%9B%E7%A8%8B%E4%BB%8B%E7%BB%8D/ title=进程介绍>进程介绍</a></li><li class=collection-item><a href=/posts/02.%E8%BF%9B%E7%A8%8Bapi/ title=进程API>进程API</a></li><li class=collection-item><a href=/posts/03.%E6%9C%89%E9%99%90%E7%9B%B4%E6%8E%A5%E6%89%A7%E8%A1%8C/ title=有限直接执行>有限直接执行</a></li><li class=collection-item><a href=/posts/04.cpu%E8%B0%83%E5%BA%A6/ title=CPU调度>CPU调度</a></li><li class=collection-item><a href=/posts/05.%E5%A4%9A%E7%BA%A7%E5%8F%8D%E9%A6%88%E9%98%9F%E5%88%97/ title=多级反馈队列>多级反馈队列</a></li><li class=collection-item><a href=/posts/06.%E6%AF%94%E4%BE%8B%E4%BB%BD%E9%A2%9D%E8%B0%83%E5%BA%A6/ title=比例份额调度>比例份额调度</a></li><li class=collection-item><a href=/posts/07.%E5%A4%9Acpu%E8%B0%83%E5%BA%A6/ title=多CPU调度>多CPU调度</a></li><li class=collection-item><a href=/posts/08.%E5%9C%B0%E5%9D%80%E7%A9%BA%E9%97%B4/ title=地址空间>地址空间</a></li><li class=collection-item><a href=/posts/09.%E5%86%85%E5%AD%98api/ title=内存API>内存API</a></li><li class=collection-item><a href=/posts/10.%E5%9C%B0%E5%9D%80%E8%BD%AC%E6%8D%A2/ title=地址转换>地址转换</a></li><li class=collection-item><a href=/posts/11.%E6%AE%B5/ title=段>段</a></li><li class=collection-item><a href=/posts/12.%E7%A9%BA%E9%97%B2%E7%A9%BA%E9%97%B4%E7%AE%A1%E7%90%86/ title=空闲空间管理>空闲空间管理</a></li><li class=collection-item><a href=/posts/13.%E9%A1%B5/ title=页>页</a></li><li class=collection-item><a href=/posts/14.%E5%BF%AB%E8%A1%A8/ title=快表>快表</a></li><li class=collection-item><a href=/posts/15.%E9%AB%98%E7%BA%A7%E9%A1%B5%E8%A1%A8/ title=高级页表>高级页表</a></li><li class=collection-item><span class=active title=页面交换>页面交换</span></li><li class=collection-item><a href=/posts/17.%E4%BA%A4%E6%8D%A2%E7%AD%96%E7%95%A5/ title=交换策略>交换策略</a></li><li class=collection-item><a href=/posts/18.%E5%AE%8C%E6%95%B4vm%E7%B3%BB%E7%BB%9F/ title=完整VM系统>完整VM系统</a></li><li class=collection-item><a href=/posts/19.%E5%B9%B6%E5%8F%91%E5%92%8C%E7%BA%BF%E7%A8%8B/ title=并发和线程>并发和线程</a></li><li class=collection-item><a href=/posts/20.%E7%BA%BF%E7%A8%8Bapi/ title=线程API>线程API</a></li><li class=collection-item><a href=/posts/21.%E9%94%81/ title=锁>锁</a></li><li class=collection-item><a href=/posts/22.%E9%94%81%E5%AE%9A%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/ title=锁定数据结构>锁定数据结构</a></li><li class=collection-item><a href=/posts/23.%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F/ title=条件变量>条件变量</a></li><li class=collection-item><a href=/posts/24.%E4%BF%A1%E5%8F%B7%E9%87%8F/ title=信号量>信号量</a></li><li class=collection-item><a href=/posts/25.%E5%B9%B6%E5%8F%91bug/ title=并发bug>并发bug</a></li><li class=collection-item><a href=/posts/26.%E5%9F%BA%E4%BA%8E%E4%BA%8B%E4%BB%B6%E7%9A%84%E5%B9%B6%E5%8F%91/ title=基于事件的并发>基于事件的并发</a></li><li class=collection-item><a href=/posts/27.io%E8%AE%BE%E5%A4%87/ title=IO设备>IO设备</a></li><li class=collection-item><a href=/posts/28.%E7%A1%AC%E7%9B%98%E9%A9%B1%E5%8A%A8%E5%99%A8/ title=硬盘驱动器>硬盘驱动器</a></li><li class=collection-item><a href=/posts/29.%E5%BB%89%E4%BB%B7%E7%A3%81%E7%9B%98%E5%86%97%E4%BD%99%E9%98%B5%E5%88%97/ title=廉价磁盘冗余阵列>廉价磁盘冗余阵列</a></li><li class=collection-item><a href=/posts/30.%E6%96%87%E4%BB%B6%E5%92%8C%E7%9B%AE%E5%BD%95/ title=文件和目录>文件和目录</a></li><li class=collection-item><a href=/posts/31.%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%AE%9E%E7%8E%B0/ title=文件系统实现>文件系统实现</a></li><li class=collection-item><a href=/posts/32.%E5%BF%AB%E9%80%9F%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/ title=快速文件系统>快速文件系统</a></li><li class=collection-item><a href=/posts/33.fsck%E5%92%8C%E6%97%A5%E5%BF%97/ title=FSCK和日志>FSCK和日志</a></li><li class=collection-item><a href=/posts/34.%E6%97%A5%E5%BF%97%E7%BB%93%E6%9E%84%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/ title=日志结构文件系统>日志结构文件系统</a></li><li class=collection-item><a href=/posts/35.%E5%9F%BA%E4%BA%8E%E9%97%AA%E5%AD%98%E7%9A%84ssd/ title=基于闪存的SSD>基于闪存的SSD</a></li><li class=collection-item><a href=/posts/36.%E6%95%B0%E6%8D%AE%E5%AE%8C%E6%95%B4%E6%80%A7%E5%92%8C%E4%BF%9D%E6%8A%A4/ title=数据完整性和保护>数据完整性和保护</a></li><li class=collection-item><a href=/posts/37.%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F/ title=分布式系统>分布式系统</a></li><li class=collection-item><a href=/posts/38.%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/ title=网络文件系统>网络文件系统</a></li><li class=collection-item><a href=/posts/39.andrew%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/ title=Andrew文件系统>Andrew文件系统</a></li></ul><div class=collection-nav-simple><a href=/posts/15.%E9%AB%98%E7%BA%A7%E9%A1%B5%E8%A1%A8/ class=collection-nav-item rel=prev title=高级页表><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i></a><span class=text-secondary>16/39</span><a href=/posts/17.%E4%BA%A4%E6%8D%A2%E7%AD%96%E7%95%A5/ class=collection-nav-item rel=next title=交换策略><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></nav></div></div></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span>页面交换</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><a href=https://github.com/HeZephyr title=作者 target=_blank rel="external nofollow noopener noreferrer author" class=author><img loading=lazy src="https://cn.gravatar.com/avatar/65f6ab71abcb9d540eb32a2704884927?s=32&amp;d=mp" alt=HeZephyr data-title=HeZephyr width=20 height=20 class=avatar style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'>&nbsp;HeZephyr</a></span><span class=post-included-in>&nbsp;收录于 <a href=/categories/%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84/ class=post-category title="分类 - 系统架构"><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> 系统架构</a> 和 <a href=/collections/ostep/ class=post-collection title="合集 - OSTEP"><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> OSTEP</a></span></div><div class=post-meta-line><span title="发布于 2024-04-25 22:40:12"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden=true></i><time datetime=2024-04-25>2024-04-25</time></span>&nbsp;<span title="更新于 2024-07-29 12:45:24"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden=true></i><time datetime=2024-07-29>2024-07-29</time></span>&nbsp;<span title="4368 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 4400 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 9 分钟</span>&nbsp;<span id=busuanzi_container_page_pv class="busuanzi_visitors comment-visitors" data-flag-title=页面交换>
<i class="fa-regular fa-eye fa-fw me-1" aria-hidden=true></i><span id=busuanzi_value_page_pv>-</span>&nbsp;次阅读
</span>&nbsp;</div></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ol><li><a href=#交换空间>交换空间</a></li><li><a href=#存在位>存在位</a></li><li><a href=#页面错误>页面错误</a></li><li><a href=#如果内存已满怎么办>如果内存已满怎么办？</a></li><li><a href=#页面错误控制流>页面错误控制流</a></li><li><a href=#当替换真正发生时>当替换真正发生时</a></li></ol></nav></div></div><div class=content id=content data-end-flag="「本文完，更多内容汇总在我的 GitHub与CSDN，持续更新，求关注、求 star、求订阅！」"><p>到目前为止，我们假设地址空间小得不切实际，并且适合物理内存。事实上，我们一直假设每个正在运行的进程的每个地址空间都适合内存。现在，我们将放宽这些重大假设，并假设我们希望支持许多并发运行的大型地址空间。</p><p>为此，我们需要在<strong>内存层次结构</strong>中增加一个级别。到目前为止，我们假设所有页面都驻留在物理内存中。然而，为了支持大地址空间，操作系统需要一个地方来存放当前需求不大的部分地址空间。一般来说，这样的位置的特点是容量要大于内存；因此，它通常会比较慢（如果它更快，我们就会将它用作内存，不是吗？）。在现代系统中，此角色通常由<strong>硬盘驱动器</strong>担任。因此，在我们的内存层次结构中，大而慢的硬盘驱动器位于底部，内存位于上面。</p><p><a class=lightgallery href="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Memory-Hierarchy-In-Modern-System.png?size=large" data-thumbnail="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Memory-Hierarchy-In-Modern-System.png?size=small" data-sub-html="<h2>image-20240403143723639</h2>"><img loading=lazy src=https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Memory-Hierarchy-In-Modern-System.png alt=image-20240403143723639 srcset="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Memory-Hierarchy-In-Modern-System.png?size=small, https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Memory-Hierarchy-In-Modern-System.png?size=medium 1.5x, https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Memory-Hierarchy-In-Modern-System.png?size=large 2x" data-title=image-20240403143723639 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><p>因此，我们找到了问题的关键： 如何超越物理内存？操作系统如何利用更大、更慢的设备来透明地提供大虚拟地址空间的假象？</p><p>您可能有一个问题：为什么我们要为进程支持单个大地址空间？答案再次是方便和易用。有了大的地址空间，您就不必担心内存中是否有足够的空间来容纳程序的数据结构；相反，您只需自然地编写程序，根据需要分配内存即可。这是操作系统提供的强大幻觉，使您的生活变得更加简单。与此形成鲜明对比的是使用<strong>内存覆盖</strong>的旧系统，它要求程序员在需要时手动将代码或数据移入或移出内存。试着想象一下这将会是什么样子：在调用函数或访问某些数据之前，你需要首先安排代码或数据进入内存。</p><p>除了单个进程之外，添加交换空间还允许操作系统为多个并发运行的进程提供大虚拟内存的假象。多道程序设计（“同时”运行多个程序，以更好地利用机器）的发明几乎需要交换某些页面的能力，因为早期的机器显然无法同时容纳所有进程所需的所有页面。因此，多道程序设计和易用性的结合使我们希望支持使用比物理可用内存更多的内存。这是所有现代 VM 系统都会做的事情；现在我们将进一步了解这一点。</p><h2 id=交换空间 class=heading-element><span>1 交换空间</span>
<a href=#%e4%ba%a4%e6%8d%a2%e7%a9%ba%e9%97%b4 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>我们需要做的第一件事是在磁盘上保留一些空间用于来回移动页面。在操作系统中，我们通常将此类空间称为<strong>交换空间</strong>，因为我们将内存中的页面交换出来，又将内存中的页面交换进去。因此，我们简单地假设操作系统可以以页面大小为单位读取和写入交换空间。为此，操作系统需要记住给定页面<strong>的磁盘地址</strong>。</p><p>交换空间的大小很重要，因为它最终决定了系统在给定时间可以使用的最大内存页数。为了简单起见，我们假设它现在非常大。</p><p>如下图所示，，您可以看到一个 4 页物理内存和 8 页交换空间的小例子。在示例中，三个进程（Proc 0、Proc 1 和 Proc 2）正在主动共享物理内存；然而，这三个页面中的每一个都只有一些有效页面位于内存中，其余部分位于磁盘上的交换空间中。第四个进程 (Proc 3) 已将其所有页面换出到磁盘，因此显然当前未运行。一区块的交换仍然是空闲的。即使从这个小例子中，希望您可以看到使用交换空间如何让系统假装内存比实际更大。</p><p><a class=lightgallery href="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Physical-Memory-And-Swap-Space.png?size=large" data-thumbnail="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Physical-Memory-And-Swap-Space.png?size=small" data-sub-html="<h2>image-20240403145118036</h2>"><img loading=lazy src=https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Physical-Memory-And-Swap-Space.png alt=image-20240403145118036 srcset="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Physical-Memory-And-Swap-Space.png?size=small, https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Physical-Memory-And-Swap-Space.png?size=medium 1.5x, https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Physical-Memory-And-Swap-Space.png?size=large 2x" data-title=image-20240403145118036 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><p>我们应该注意，交换空间并不是交换流量的唯一磁盘位置。例如，假设您正在运行一个程序二进制文件（例如 ls 或您自己编译的主程序）。该二进制文件中的代码页最初在磁盘上找到，当程序运行时，它们被加载到内存中（或者在程序开始执行时一次全部加载，或者像在现代系统中一样，在需要时一次加载一页）。但是，如果系统需要在物理内存中腾出空间来满足其他需求，它可以安全地重新使用这些代码页的内存空间，因为它知道以后可以从文件系统中的磁盘二进制文件中再次交换它们。</p><h2 id=存在位 class=heading-element><span>2 存在位</span>
<a href=#%e5%ad%98%e5%9c%a8%e4%bd%8d class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>现在我们在磁盘上有了一些空间，我们需要在系统中添加一些更高级别的机器，以支持与磁盘之间的页面交换。为简单起见，我们假设我们有一个带有硬件管理的 TLB 的系统。</p><p>首先回想一下内存引用上发生的情况。运行的进程生成虚拟内存引用（用于指令获取或数据访问），在这种情况下，硬件在从内存中获取所需数据之前将它们转换为物理地址。</p><p>请记住，硬件首先从虚拟地址中提取 VPN，检查 TLB 是否匹配（<strong>TLB 命中</strong>），如果命中，则生成结果物理地址并从内存中获取它。这希望是常见情况，因为它速度很快（不需要额外的内存访问）。</p><p>如果在 TLB 中未找到 VPN（即 TLB 未命中），硬件将在内存中定位页表（使用<font color=red>页表基址寄存器</font>），并使用 VPN 查找该页的页表条目 (PTE)：一个索引。如果该页有效并且存在于物理内存中，则硬件从 PTE 中提取 PFN，将其安装到 TLB 中，并重试该指令，这次生成 TLB 命中；到目前为止，一切都很好。</p><p>然而，如果我们希望允许页面交换到磁盘，我们必须添加更多的机器。具体来说，当硬件查看PTE时，它可能会发现物理内存中不存在该页。硬件（或操作系统，在软件管理的 TLB 方法中）确定这一点的方式是通过每个页表条目中的一条新信息（称为存在位，the present bit）。如果存在位设置为 1，则意味着该页存在于物理内存中，并且一切按上述进行；如果它设置为零，则该页面不在内存中，而是在磁盘上的某个位置。访问不在物理内存中的页面的行为通常称为<strong>页面错误</strong>。</p><p>出现页面错误时，将调用操作系统来处理页面错误。正如我们现在所描述的，运行一段称为<strong>页面错误处理程序</strong>的特定代码，并且必须为页面错误提供服务。</p><h2 id=页面错误 class=heading-element><span>3 页面错误</span>
<a href=#%e9%a1%b5%e9%9d%a2%e9%94%99%e8%af%af class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>回想一下，对于 TLB 未命中，我们有两种类型的系统：硬件管理的 TLB（硬件在页表中查找所需的转换）和软件管理的 TLB（操作系统执行的操作）。在任一类型的系统中，如果页面不存在，操作系统将负责处理页面错误。操作系统页面错误处理程序将运行以确定要做什么。几乎所有系统都通过软件来处理页面错误；即使使用硬件管理的 TLB，硬件也会信任操作系统来管理这项重要职责。</p><p>如果页面不存在并且已交换到磁盘，操作系统将需要将该页面交换到内存中以解决页面错误。因此，出现了一个问题：操作系统如何知道在哪里可以找到所需的页面？在许多系统中，页表是存储此类信息的自然位置。因此，操作系统可以使用 PTE 中通常用于数据的位，例如磁盘地址页面的 PFN。当操作系统收到页面的缺页错误时，它会在 PTE 中查找地址，并向磁盘发出请求以将该页面提取到内存中。</p><p>当磁盘 I/O 完成时，操作系统将更新页表以将页面标记为存在，更新页表项 (PTE) 的 PFN 字段以记录新获取的页面在内存中的位置，并重试该指令。下一次尝试可能会生成 TLB 未命中，然后将对其进行处理并通过转换更新 TLB（可以在处理页错误时交替更新 TLB，以避免此步骤）。最后，最后一次重新启动将在 TLB 中找到转换，从而继续从内存中转换后的物理地址获取所需的数据或指令。</p><p>请注意，当 I/O 正在进行时，进程将处于阻塞状态。因此，在处理页面错误时，操作系统将可以自由地运行其他就绪进程。由于 I/O 的成本很高，因此一个进程的 I/O（页面错误）与另一个进程的执行的重叠是多道程序系统最有效地利用其硬件的另一种方式。</p><h2 id=如果内存已满怎么办 class=heading-element><span>4 如果内存已满怎么办？</span>
<a href=#%e5%a6%82%e6%9e%9c%e5%86%85%e5%ad%98%e5%b7%b2%e6%bb%a1%e6%80%8e%e4%b9%88%e5%8a%9e class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>在上述过程中，您可能会注意到，我们假设有足够的可用内存可从交换空间调入页面。当然，情况也可能并非如此；内存可能已满（或接近满）。因此，操作系统可能希望首先调出一个或多个页面，以便为操作系统即将引入的新页面腾出空间。选择要踢出或替换的页面的过程称为<font color=red>页面替换策略</font>。</p><p>事实证明，我们在创建良好的页面替换策略时花费了很多心思，因为踢出错误的页面可能会给程序性能带来巨大的损失。做出错误的决定可能会导致程序以类似磁盘的速度而不是类似内存的速度运行；在当前技术中，这意味着程序的运行速度可能会慢 10,000 或 100,000 倍。所以，这样的策略是值得我们仔细研究的。事实上，这正是我们在下一章中要做的事情。现在，只要理解这样的政策的存在就足够了，它建立在此处描述的机制之上。</p><h2 id=页面错误控制流 class=heading-element><span>5 页面错误控制流</span>
<a href=#%e9%a1%b5%e9%9d%a2%e9%94%99%e8%af%af%e6%8e%a7%e5%88%b6%e6%b5%81 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>有了这些知识，我们现在就可以大致勾勒出内存访问的完整控制流程，如下图所示。</p><p><a class=lightgallery href="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Page-Fault-Control-Flow-Example.png?size=large" data-thumbnail="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Page-Fault-Control-Flow-Example.png?size=small" data-sub-html="<h2>image-20240403222023971</h2>"><img loading=lazy src=https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Page-Fault-Control-Flow-Example.png alt=image-20240403222023971 srcset="https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Page-Fault-Control-Flow-Example.png?size=small, https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Page-Fault-Control-Flow-Example.png?size=medium 1.5x, https://raw.githubusercontent.com/unique-pure/NewPicGoLibrary/main/img/Page-Fault-Control-Flow-Example.png?size=large 2x" data-title=image-20240403222023971 style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'></a></p><p>换句话说，当有人问你 &ldquo;当程序从内存中获取一些数据时会发生什么？&ldquo;时，你应该对所有不同的可能性有一个相当好的概念，如下面两段代码所示。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Page-Fault Control Flow Algorithm (Hardware)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>1</span> <span class=n>VPN</span> <span class=o>=</span> <span class=p>(</span><span class=n>VirtualAddress</span> <span class=o>&amp;</span> <span class=n>VPN_MASK</span><span class=p>)</span> <span class=o>&gt;&gt;</span> <span class=n>SHIFT</span>
</span></span><span class=line><span class=cl><span class=mi>2</span> <span class=p>(</span><span class=n>Success</span><span class=p>,</span> <span class=n>TlbEntry</span><span class=p>)</span> <span class=o>=</span> <span class=nf>TLB_Lookup</span><span class=p>(</span><span class=n>VPN</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>3</span> <span class=k>if</span> <span class=p>(</span><span class=n>Success</span> <span class=o>==</span> <span class=n>True</span><span class=p>)</span> <span class=c1>// TLB Hit
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>4</span>     <span class=k>if</span> <span class=p>(</span><span class=nf>CanAccess</span><span class=p>(</span><span class=n>TlbEntry</span><span class=p>.</span><span class=n>ProtectBits</span><span class=p>)</span> <span class=o>==</span> <span class=n>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>5</span>         <span class=n>Offset</span> <span class=o>=</span> <span class=n>VirtualAddress</span> <span class=o>&amp;</span> <span class=n>OFFSET_MASK</span>
</span></span><span class=line><span class=cl><span class=mi>6</span>         <span class=n>PhysAddr</span> <span class=o>=</span> <span class=p>(</span><span class=n>TlbEntry</span><span class=p>.</span><span class=n>PFN</span> <span class=o>&lt;&lt;</span> <span class=n>SHIFT</span><span class=p>)</span> <span class=o>|</span> <span class=n>Offset</span>
</span></span><span class=line><span class=cl><span class=mi>7</span>         <span class=n>Register</span> <span class=o>=</span> <span class=nf>AccessMemory</span><span class=p>(</span><span class=n>PhysAddr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>8</span>     <span class=k>else</span>
</span></span><span class=line><span class=cl><span class=mi>9</span>         <span class=nf>RaiseException</span><span class=p>(</span><span class=n>PROTECTION_FAULT</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>10</span> <span class=k>else</span> <span class=c1>// TLB Miss
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>11</span>    <span class=n>PTEAddr</span> <span class=o>=</span> <span class=n>PTBR</span> <span class=o>+</span> <span class=p>(</span><span class=n>VPN</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>PTE</span><span class=p>))</span>
</span></span><span class=line><span class=cl><span class=mi>12</span>    <span class=n>PTE</span> <span class=o>=</span> <span class=nf>AccessMemory</span><span class=p>(</span><span class=n>PTEAddr</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>13</span>    <span class=k>if</span> <span class=p>(</span><span class=n>PTE</span><span class=p>.</span><span class=n>Valid</span> <span class=o>==</span> <span class=n>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>14</span>        <span class=nf>RaiseException</span><span class=p>(</span><span class=n>SEGMENTATION_FAULT</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>15</span>    <span class=k>else</span>
</span></span><span class=line><span class=cl><span class=mi>16</span>        <span class=k>if</span> <span class=p>(</span><span class=nf>CanAccess</span><span class=p>(</span><span class=n>PTE</span><span class=p>.</span><span class=n>ProtectBits</span><span class=p>)</span> <span class=o>==</span> <span class=n>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>17</span>            <span class=nf>RaiseException</span><span class=p>(</span><span class=n>PROTECTION_FAULT</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>18</span>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>PTE</span><span class=p>.</span><span class=n>Present</span> <span class=o>==</span> <span class=n>True</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>19</span>            <span class=c1>// assuming hardware-managed TLB
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>20</span>            <span class=nf>TLB_Insert</span><span class=p>(</span><span class=n>VPN</span><span class=p>,</span> <span class=n>PTE</span><span class=p>.</span><span class=n>PFN</span><span class=p>,</span> <span class=n>PTE</span><span class=p>.</span><span class=n>ProtectBits</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>21</span>            <span class=nf>RetryInstruction</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>22</span>        <span class=k>else</span> <span class=k>if</span> <span class=p>(</span><span class=n>PTE</span><span class=p>.</span><span class=n>Present</span> <span class=o>==</span> <span class=n>False</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=mi>23</span>            <span class=nf>RaiseException</span><span class=p>(</span><span class=n>PAGE_FAULT</span><span class=p>)</span></span></span></code></pre></td></tr></table></div></div><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// Page-Fault Control Flow Algorithm (Software)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>1</span> <span class=n>PFN</span> <span class=o>=</span> <span class=nf>FindFreePhysicalPage</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=mi>2</span> <span class=k>if</span> <span class=p>(</span><span class=n>PFN</span> <span class=o>==</span> <span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=c1>// no free page found
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>3</span>     <span class=n>PFN</span> <span class=o>=</span> <span class=nf>EvictPage</span><span class=p>()</span> <span class=c1>// run replacement algorithm
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>4</span>     <span class=nf>DiskRead</span><span class=p>(</span><span class=n>PTE</span><span class=p>.</span><span class=n>DiskAddr</span><span class=p>,</span> <span class=n>PFN</span><span class=p>)</span> <span class=c1>// sleep (waiting for I/O)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>5</span>     <span class=n>PTE</span><span class=p>.</span><span class=n>present</span> <span class=o>=</span> <span class=n>True</span> <span class=c1>// update page table with present bit
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>6</span>     <span class=n>PTE</span><span class=p>.</span><span class=n>PFN</span> <span class=o>=</span> <span class=n>PFN</span> <span class=c1>// and translation (PFN)
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=mi>7</span>     <span class=nf>RetryInstruction</span><span class=p>()</span> <span class=c1>// retry instruction
</span></span></span></code></pre></td></tr></table></div></div><p>第一段代码显示了硬件在转换过程中的操作，第二段代码显示了操作系统在发生页面错误时的操作。</p><p>从第一段代码中的硬件控制流程可以看出，当发生 TLB 未命中时，有三种重要情况需要了解。第一种情况是<font color=red>页面既存在又有效（第 18-21 行）</font>；在这种情况下，TLB 未命中处理程序可以简单地从 PTE 中获取 PFN，重试指令（这次会导致 TLB 命中），然后继续之前（多次）描述的操作。在第二种情况下（第 22-23 行），必须运行页面错误处理程序；虽然进程访问的页面是合法的（毕竟是有效的），但它不在物理内存中。第三种（也是最后一种）情况是访问的页面无效，例如由于程序中的错误（第 13-14 行）。在这种情况下，PTE 中的其他位都不重要；硬件会捕获这种无效访问，操作系统中断处理程序也会运行，从而终止违规进程。</p><p>从第二段代码的软件控制流中我们可以看到操作系统处理页面错误的大致步骤。首先，操作系统必须为即将发生错误的页面找到一个物理页号；如果没有这样的页面，我们就必须等待替换算法运行，将一些页面踢出内存，从而释放出这些页面供此处使用。有了物理页，处理程序就会发出 I/O 请求以从交换空间读入页面。最后，当缓慢的操作完成时，操作系统会更新页表并重试该指令。重试将导致 TLB 未命中，然后，在另一次重试时，TLB 命中，此时硬件将能够访问所需的项。</p><h2 id=当替换真正发生时 class=heading-element><span>6 当替换真正发生时</span>
<a href=#%e5%bd%93%e6%9b%bf%e6%8d%a2%e7%9c%9f%e6%ad%a3%e5%8f%91%e7%94%9f%e6%97%b6 class=heading-mark><svg class="octicon octicon-link" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true"><path d="m7.775 3.275 1.25-1.25a3.5 3.5.0 114.95 4.95l-2.5 2.5a3.5 3.5.0 01-4.95.0.751.751.0 01.018-1.042.751.751.0 011.042-.018 1.998 1.998.0 002.83.0l2.5-2.5a2.002 2.002.0 00-2.83-2.83l-1.25 1.25a.751.751.0 01-1.042-.018.751.751.0 01-.018-1.042zm-4.69 9.64a1.998 1.998.0 002.83.0l1.25-1.25a.751.751.0 011.042.018.751.751.0 01.018 1.042l-1.25 1.25a3.5 3.5.0 11-4.95-4.95l2.5-2.5a3.5 3.5.0 014.95.0.751.751.0 01-.018 1.042.751.751.0 01-1.042.018 1.998 1.998.0 00-2.83.0l-2.5 2.5a1.998 1.998.0 000 2.83z"/></svg></a></h2><p>到目前为止，我们描述替换如何发生的方式是假设操作系统等待内存完全满，然后才替换（逐出）页面为其他页面腾出空间。正如您可以想象的那样，这有点不现实，操作系统主动保留一小部分内存的原因有很多。</p><p>为了保持少量内存空闲，大多数操作系统都有某种<font color=red>高水位线（HW）和低水位线（LW）</font>来帮助决定何时开始从内存中逐出页面。其工作原理如下：当操作系统注意到可用的 LW 页数较少时，负责释放内存的后台线程就会运行。该线程逐出页面，直到有可用的硬件页面。**后台线程（有时称为交换守护程序或页面守护程序）**然后进入睡眠状态，很高兴它释放了一些内存供正在运行的进程和操作系统使用。</p><p>通过同时执行多个替换，新的性能优化成为可能。例如，许多系统会将多个页面<strong>聚集或分组</strong>并立即将它们写入交换分区，从而提高磁盘的效率；正如我们稍后更详细地讨论磁盘时将看到的那样，这种集群减少了磁盘的查找和旋转开销，从而显着提高了性能。</p><p>为了与后台分页线程一起工作，上面的第二段代码控制流应该稍微修改一下；该算法不会直接执行替换，而是简单地检查是否有可用的空闲页面。如果没有，它会通知后台分页线程需要空闲页面；当线程释放一些页面时，它会重新唤醒原始线程，然后原始线程可以调入所需的页面并继续其工作。</p></div><hr class=awesome-hr><h2 id=see-also>相关内容</h2><ul><li><a href=/posts/15.%E9%AB%98%E7%BA%A7%E9%A1%B5%E8%A1%A8/ title=高级页表>高级页表</a></li><li><a href=/posts/14.%E5%BF%AB%E8%A1%A8/ title=快表>快表</a></li><li><a href=/posts/13.%E9%A1%B5/ title=页>页</a></li><li><a href=/posts/12.%E7%A9%BA%E9%97%B2%E7%A9%BA%E9%97%B4%E7%AE%A1%E7%90%86/ title=空闲空间管理>空闲空间管理</a></li><li><a href=/posts/11.%E6%AE%B5/ title=段>段</a></li></ul><div class=post-reward><div class=comment>Buy me a coffee~</div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward><i class="fa-solid fa-qrcode fa-fw" aria-hidden=true></i>赞赏</label><div class=reward-ways data-mode=fixed><div><img loading=lazy src=/images/alipay.png alt="HeZephyr 支付宝" data-title="HeZephyr 支付宝" style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span data-animation>支付宝</span></div><div><img loading=lazy src=/images/wechatpay.jpg alt="HeZephyr 微信" data-title="HeZephyr 微信" style="background:url(/images/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title;for(const e of["style","data-title","onerror","onload"])this.removeAttribute(e)'><span data-animation>微信</span></div></div></div><div class=collection-card><div class="collection-title text-secondary">收录于 <a href=/collections/ostep/><i class="fa-solid fa-layer-group fa-fw" aria-hidden=true></i> <span>合集・OSTEP</span></span></a> 39</div><div class=collection-nav><a href=/posts/15.%E9%AB%98%E7%BA%A7%E9%A1%B5%E8%A1%A8/ class=collection-nav-item rel=prev title=高级页表><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i><span>高级页表</span>
</a><a href=/posts/17.%E4%BA%A4%E6%8D%A2%E7%AD%96%E7%95%A5/ class=collection-nav-item rel=next title=交换策略><span>交换策略</span><i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2024-07-29 12:45:24">更新于 2024-07-29&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md><span><a href=/posts/16.%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2/index.md title=阅读原始文档 class=link-to-markdown>阅读原始文档</a></span><span><a href="https://github.com/HeZephyr/HeZephyr.github.io/blob/docs/content/posts/_develop/_system/ostep/16.%e9%a1%b5%e9%9d%a2%e4%ba%a4%e6%8d%a2.md?plain=1" title=查看源码 target=_blank rel="external nofollow noopener noreferrer" class=link-to-source>查看源码</a></span><span><a href=https://github.com/HeZephyr/HeZephyr.github.io/edit/docs/content/posts/_develop/_system/ostep/16.%e9%a1%b5%e9%9d%a2%e4%ba%a4%e6%8d%a2.md title=编辑此页 target=_blank rel="external nofollow noopener noreferrer" class=link-to-edit>编辑此页</a></span><span><a href="https://github.com/HeZephyr/HeZephyr.github.io/issues/new?title=[BUG]%20%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2&amp;body=%7cField%7cValue%7c%0A%7c-%7c-%7c%0A%7cTitle%7c%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2%7c%0A%7cURL%7chttps://hezephyr.github.io/posts/16.%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2/%7c%0A%7cFilename%7chttps://github.com/HeZephyr/HeZephyr.github.io/blob/docs/content/posts/_develop/_system/ostep/16.%e9%a1%b5%e9%9d%a2%e4%ba%a4%e6%8d%a2.md?plain=1%7c" title=报告问题 target=_blank rel="external nofollow noopener noreferrer" class=link-to-report>报告问题</a></span></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 X" data-sharer=twitter data-url=https://hezephyr.github.io/posts/16.%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2/ data-title=页面交换 data-hashtags=OS><i class="fa-brands fa-x-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=https://hezephyr.github.io/posts/16.%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2/ data-hashtag=OS><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Linkedin" data-sharer=linkedin data-url=https://hezephyr.github.io/posts/16.%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2/><i class="fa-brands fa-linkedin fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=https://hezephyr.github.io/posts/16.%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2/ data-title=页面交换><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 百度" data-sharer=baidu data-url=https://hezephyr.github.io/posts/16.%E9%A1%B5%E9%9D%A2%E4%BA%A4%E6%8D%A2/ data-title=页面交换><i data-svg-src=https://unpkg.com/simple-icons@9.19.0/icons/baidu.svg aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/os/ class=post-tag title="标签 - OS">OS</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/17.%E4%BA%A4%E6%8D%A2%E7%AD%96%E7%95%A5/ class=post-nav-item rel=prev title=交换策略><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>交换策略</a>
<a href=/posts/15.%E9%AB%98%E7%BA%A7%E9%A1%B5%E8%A1%A8/ class=post-nav-item rel=next title=高级页表>高级页表<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div id=comments><div id=giscus class=comment><script src=https://giscus.app/client.js data-repo=HeZephyr/HeZephyr.github.io data-repo-id=R_kgDOMb2HgQ data-category=General data-category-id=DIC_kwDOMb2Hgc4ChPAb data-mapping=title data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article><aside class=toc id=toc-auto aria-label=目录><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside></main><footer class=footer><div class=footer-container><div class="footer-line powered order-1">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.129.0"><img class=hugo-icon src=/images/hugo.min.svg alt="Hugo logo"> Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.3.9-RC"><img class=fixit-icon src=/images/fixit.min.svg alt="FixIt logo"> FixIt</a></div><div class="footer-line copyright order-2" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2020 - 2024</span><span class=author itemprop=copyrightHolder>
<a href=https://github.com/HeZephyr target=_blank rel="external nofollow noopener noreferrer">HeZephyr</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-sa/4.0/ target=_blank>CC BY-NC-SA 4.0</a></span></div><div class="footer-line statistics"><span class=site-time title=网站运行中……><i class="fa-solid fa-heartbeat fa-fw animate-icon" aria-hidden=true></i><span class="ms-1 d-none">博客已运行</span><span class="run-times ms-1">网站运行中……</span></span></div><div class="footer-line visitor order-first"><span id=busuanzi_container_site_uv title=总访客数><i class="fa-regular fa-user fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_uv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span><span id=busuanzi_container_site_pv class=footer-divider title=总访问量><i class="fa-regular fa-eye fa-fw" aria-hidden=true></i>&nbsp;<span id=busuanzi_value_site_pv><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden=true></i></span></span></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class=variant-numeric>0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/HeZephyr title="View on GitHub" target=_blank rel="external nofollow" class="github-corner right d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true" width="56" height="56"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><div class=reading-progress-bar style=left:0;top:0;--bg-progress:#8581dd;--bg-progress-dark:#fff></div><noscript><div class=noscript-warning>该网站在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=https://unpkg.com/lightgallery@2.7.2/css/lightgallery-bundle.min.css><link rel=preload href=https://unpkg.com/katex@0.16.10/dist/katex.min.css as=style onload='this.removeAttribute("onload"),this.rel="stylesheet"'><noscript><link rel=stylesheet href=https://unpkg.com/katex@0.16.10/dist/katex.min.css></noscript><link rel=stylesheet href=https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.css><link rel=stylesheet href=https://unpkg.com/pace-js@1.2.4/themes/blue/pace-theme-minimal.css><script src=https://unpkg.com/autocomplete.js@0.38.1/dist/autocomplete.min.js defer></script><script src=https://unpkg.com/algoliasearch@4.20.0/dist/algoliasearch-lite.umd.js defer></script><script src=https://unpkg.com/instant.page@5.2.0/instantpage.js async defer type=module></script><script src=https://unpkg.com/lightgallery@2.7.2/lightgallery.min.js defer></script><script src=https://unpkg.com/lightgallery@2.7.2/plugins/thumbnail/lg-thumbnail.min.js defer></script><script src=https://unpkg.com/lightgallery@2.7.2/plugins/zoom/lg-zoom.min.js defer></script><script src=https://unpkg.com/sharer.js@0.5.1/sharer.min.js async defer></script><script src=https://unpkg.com/katex@0.16.10/dist/katex.min.js defer></script><script src=https://unpkg.com/katex@0.16.10/dist/contrib/auto-render.min.js defer></script><script src=https://unpkg.com/katex@0.16.10/dist/contrib/copy-tex.min.js defer></script><script src=https://unpkg.com/katex@0.16.10/dist/contrib/mhchem.min.js defer></script><script src=https://unpkg.com/cookieconsent@3.1.1/build/cookieconsent.min.js defer></script><script src=https://unpkg.com/pangu@4.0.7/dist/browser/pangu.min.js defer></script><script src=https://unpkg.com/cell-watermark@1.0.3/src/watermark.min.js defer></script><script src=//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js async defer></script><script src=https://unpkg.com/pace-js@1.2.4/pace.min.js async defer></script><script src=/js/flyfish.js defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:50},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark_dimmed",lightTheme:"light",origin:"https://giscus.app"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},enablePWA:!0,lightgallery:!0,math:{delimiters:[{display:!0,left:"$$",right:"$$"},{display:!0,left:"\\[",right:"\\]"},{display:!0,left:"\\begin{equation}",right:"\\end{equation}"},{display:!0,left:"\\begin{equation*}",right:"\\end{equation*}"},{display:!0,left:"\\begin{align}",right:"\\end{align}"},{display:!0,left:"\\begin{align*}",right:"\\end{align*}"},{display:!0,left:"\\begin{alignat}",right:"\\end{alignat}"},{display:!0,left:"\\begin{alignat*}",right:"\\end{alignat*}"},{display:!0,left:"\\begin{gather}",right:"\\end{gather}"},{display:!0,left:"\\begin{CD}",right:"\\end{CD}"},{display:!0,left:"$$",right:"$$"},{display:!1,left:"$",right:"$"},{display:!1,left:"\\(",right:"\\)"},{display:!1,left:"$",right:"$"}],strict:!1},pangu:{enable:!0,selector:"article"},search:{algoliaAppID:"LKM6MKQ6NB",algoliaIndex:"index",algoliaSearchKey:"c9bb91e3a1318f3c9efae98daa87bca5",highlightTag:"em",maxResultLength:10,noResultsFound:"没有找到结果",snippetLength:50,type:"algolia"},siteTime:"2020-06-10T15:42:01+08:00",version:"v0.3.9-RC",watermark:{colspacing:30,content:'<img style="height: 0.85rem;" src="/logo.png" alt="logo" /> 贺志飞',enable:!0,fontfamily:"LiuJianMaoCao-Regular, 钟齐流江毛草",fontsize:1.1,height:20,opacity:.0125,rotate:15,rowspacing:60,width:150}}</script><script src=/js/theme.min.js defer></script><script src=/js/custom.min.js defer></script></body></html>